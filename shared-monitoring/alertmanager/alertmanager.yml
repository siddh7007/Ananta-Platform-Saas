# =============================================================================
# AlertManager Configuration - Ananta Platform
# =============================================================================
# Handles alert routing, grouping, and notification delivery
# =============================================================================

global:
  # How long to wait before sending a notification again if it has already
  # been sent successfully for an alert
  resolve_timeout: 5m

  # SMTP settings for email notifications (configure as needed)
  # smtp_smarthost: 'smtp.example.com:587'
  # smtp_from: 'alertmanager@ananta.io'
  # smtp_auth_username: 'alertmanager'
  # smtp_auth_password: 'password'

  # Slack webhook URL (configure as needed)
  # slack_api_url: 'https://hooks.slack.com/services/YOUR/WEBHOOK/URL'

# The root route - all alerts start here
route:
  # The default receiver
  receiver: 'default-receiver'

  # How long to initially wait to buffer alerts of the same group
  group_wait: 30s

  # How long to wait before sending a notification about new alerts
  # that are added to a group of alerts
  group_interval: 5m

  # How long to wait before sending a notification again if it has
  # already been sent successfully
  repeat_interval: 4h

  # Group alerts by these labels
  group_by: ['alertname', 'severity', 'plane', 'service']

  # Child routes for more specific routing
  routes:
    # Critical alerts - immediate notification
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 10s
      repeat_interval: 1h
      continue: true

    # Control Plane (Ananta-SaaS) alerts
    - match:
        plane: control
      receiver: 'control-plane-alerts'
      group_by: ['alertname', 'service']
      continue: true

    # App Plane alerts
    - match:
        plane: app
      receiver: 'app-plane-alerts'
      group_by: ['alertname', 'service']
      continue: true

    # CNS Service specific alerts
    - match:
        service: cns-service
      receiver: 'cns-alerts'
      group_by: ['alertname', 'check']

    # Infrastructure alerts
    - match_re:
        service: (redis|rabbitmq|minio)
      receiver: 'infrastructure-alerts'
      group_by: ['service']

# Inhibition rules - prevent duplicate alerts
inhibit_rules:
  # If a critical alert is firing, inhibit warning alerts for the same service
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service']

  # If service is down, inhibit specific health check alerts
  - source_match:
      alertname: 'CNSServiceDown'
    target_match_re:
      alertname: 'CNS.*'
    equal: ['service']

  - source_match:
      alertname: 'TenantManagementServiceDown'
    target_match_re:
      alertname: 'TenantManagement.*'
    equal: ['service']

# Receiver configurations
receivers:
  # Default receiver - logs to console (for development)
  - name: 'default-receiver'
    webhook_configs:
      - url: 'http://localhost:9999/webhook'
        send_resolved: true
        # This URL doesn't exist - alerts will be visible in AlertManager UI

  # Critical alerts receiver
  - name: 'critical-alerts'
    webhook_configs:
      - url: 'http://localhost:9999/critical'
        send_resolved: true
    # Uncomment and configure for real notifications:
    # email_configs:
    #   - to: 'oncall@ananta.io'
    #     send_resolved: true
    # slack_configs:
    #   - channel: '#critical-alerts'
    #     send_resolved: true
    #     title: '{{ .Status | toUpper }}{{ if eq .Status "firing" }} - {{ .CommonAnnotations.summary }}{{ end }}'
    #     text: '{{ .CommonAnnotations.description }}'

  # Control Plane alerts
  - name: 'control-plane-alerts'
    webhook_configs:
      - url: 'http://localhost:9999/control-plane'
        send_resolved: true
    # slack_configs:
    #   - channel: '#control-plane-alerts'
    #     send_resolved: true

  # App Plane alerts
  - name: 'app-plane-alerts'
    webhook_configs:
      - url: 'http://localhost:9999/app-plane'
        send_resolved: true
    # slack_configs:
    #   - channel: '#app-plane-alerts'
    #     send_resolved: true

  # CNS Service alerts
  - name: 'cns-alerts'
    webhook_configs:
      - url: 'http://localhost:9999/cns'
        send_resolved: true
    # slack_configs:
    #   - channel: '#cns-alerts'
    #     send_resolved: true

  # Infrastructure alerts
  - name: 'infrastructure-alerts'
    webhook_configs:
      - url: 'http://localhost:9999/infrastructure'
        send_resolved: true
    # slack_configs:
    #   - channel: '#infrastructure-alerts'
    #     send_resolved: true

# Templates for notifications
templates:
  - '/etc/alertmanager/templates/*.tmpl'
