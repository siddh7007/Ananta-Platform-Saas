# =============================================================================
# Terraform Drift Detection Workflow
# =============================================================================
# Automatically detects configuration drift between actual infrastructure
# and Terraform state. Runs every 6 hours and sends alerts on drift.
# =============================================================================

name: Terraform Drift Detection

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to check for drift'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - dev
          - staging
          - prod

permissions:
  contents: read
  id-token: write
  issues: write

env:
  TF_VERSION: '1.5.7'
  TF_WORKING_DIR: 'infrastructure/terraform'
  AWS_REGION: 'us-east-1'

jobs:
  # ---------------------------------------------------------------------------
  # Drift Detection (Dev)
  # ---------------------------------------------------------------------------
  drift-dev:
    name: Drift Detection (Dev)
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.environment == 'all' || github.event.inputs.environment == 'dev'))
    environment: dev
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=ananta-platform/dev/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ secrets.TF_LOCK_TABLE }}" \
            -lock-timeout=300s
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Plan (Drift Check)
        id: plan
        run: |
          terraform plan \
            -var-file="environments/dev.tfvars" \
            -detailed-exitcode \
            -lock-timeout=300s \
            -no-color 2>&1 | tee drift-output.txt
        working-directory: ${{ env.TF_WORKING_DIR }}
        continue-on-error: true

      - name: Check for Drift
        id: drift
        run: |
          EXIT_CODE=${{ steps.plan.outputs.exitcode }}
          if [ "$EXIT_CODE" -eq "2" ]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "DRIFT DETECTED in dev environment"
          elif [ "$EXIT_CODE" -eq "0" ]; then
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "No drift detected in dev environment"
          else
            echo "drift_detected=error" >> $GITHUB_OUTPUT
            echo "ERROR: Terraform plan failed"
            exit 1
          fi

      - name: Upload Drift Report
        if: steps.drift.outputs.drift_detected == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: drift-report-dev
          path: ${{ env.TF_WORKING_DIR }}/drift-output.txt

      - name: Create GitHub Issue on Drift
        if: steps.drift.outputs.drift_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const driftOutput = fs.readFileSync('${{ env.TF_WORKING_DIR }}/drift-output.txt', 'utf8');
            const truncatedOutput = driftOutput.length > 60000
              ? driftOutput.substring(0, 60000) + '\n\n... (truncated)'
              : driftOutput;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Terraform Drift Detected (Dev)',
              labels: ['drift', 'infrastructure', 'dev'],
              body: `## Infrastructure Drift Detected

**Environment**: Dev
**Detected**: ${new Date().toISOString()}
**Workflow**: [${context.workflow}](${context.payload.repository.html_url}/actions/runs/${context.runId})

### Drift Details

<details><summary>Show Terraform Plan</summary>

\`\`\`terraform
${truncatedOutput}
\`\`\`

</details>

### Action Required

1. Review the drift details above
2. Determine if drift is expected or requires remediation
3. If expected: Update Terraform configuration to match
4. If unexpected: Investigate and restore to desired state
5. Close this issue once resolved

**Note**: Automated drift detection runs every 6 hours.
`
            });

  # ---------------------------------------------------------------------------
  # Drift Detection (Staging)
  # ---------------------------------------------------------------------------
  drift-staging:
    name: Drift Detection (Staging)
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.environment == 'all' || github.event.inputs.environment == 'staging'))
    environment: staging
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_STAGING }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=ananta-platform/staging/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ secrets.TF_LOCK_TABLE }}" \
            -lock-timeout=300s
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Plan (Drift Check)
        id: plan
        run: |
          terraform plan \
            -var-file="environments/staging.tfvars" \
            -detailed-exitcode \
            -lock-timeout=300s \
            -no-color 2>&1 | tee drift-output.txt
        working-directory: ${{ env.TF_WORKING_DIR }}
        continue-on-error: true

      - name: Check for Drift
        id: drift
        run: |
          EXIT_CODE=${{ steps.plan.outputs.exitcode }}
          if [ "$EXIT_CODE" -eq "2" ]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "DRIFT DETECTED in staging environment"
          elif [ "$EXIT_CODE" -eq "0" ]; then
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "No drift detected in staging environment"
          else
            echo "drift_detected=error" >> $GITHUB_OUTPUT
            echo "ERROR: Terraform plan failed"
            exit 1
          fi

      - name: Upload Drift Report
        if: steps.drift.outputs.drift_detected == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: drift-report-staging
          path: ${{ env.TF_WORKING_DIR }}/drift-output.txt

      - name: Create GitHub Issue on Drift
        if: steps.drift.outputs.drift_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const driftOutput = fs.readFileSync('${{ env.TF_WORKING_DIR }}/drift-output.txt', 'utf8');
            const truncatedOutput = driftOutput.length > 60000
              ? driftOutput.substring(0, 60000) + '\n\n... (truncated)'
              : driftOutput;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Terraform Drift Detected (Staging)',
              labels: ['drift', 'infrastructure', 'staging', 'priority:high'],
              body: `## Infrastructure Drift Detected

**Environment**: Staging
**Detected**: ${new Date().toISOString()}
**Workflow**: [${context.workflow}](${context.payload.repository.html_url}/actions/runs/${context.runId})

### Drift Details

<details><summary>Show Terraform Plan</summary>

\`\`\`terraform
${truncatedOutput}
\`\`\`

</details>

### Action Required

1. Review the drift details above
2. Determine if drift is expected or requires remediation
3. If expected: Update Terraform configuration to match
4. If unexpected: Investigate and restore to desired state
5. Close this issue once resolved

**Note**: Automated drift detection runs every 6 hours.
`
            });

  # ---------------------------------------------------------------------------
  # Drift Detection (Prod)
  # ---------------------------------------------------------------------------
  drift-prod:
    name: Drift Detection (Prod)
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.environment == 'all' || github.event.inputs.environment == 'prod'))
    environment: prod
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PROD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=ananta-platform/prod/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ secrets.TF_LOCK_TABLE }}" \
            -lock-timeout=300s
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Plan (Drift Check)
        id: plan
        run: |
          terraform plan \
            -var-file="environments/prod.tfvars" \
            -detailed-exitcode \
            -lock-timeout=300s \
            -no-color 2>&1 | tee drift-output.txt
        working-directory: ${{ env.TF_WORKING_DIR }}
        continue-on-error: true

      - name: Check for Drift
        id: drift
        run: |
          EXIT_CODE=${{ steps.plan.outputs.exitcode }}
          if [ "$EXIT_CODE" -eq "2" ]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "DRIFT DETECTED in prod environment"
          elif [ "$EXIT_CODE" -eq "0" ]; then
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "No drift detected in prod environment"
          else
            echo "drift_detected=error" >> $GITHUB_OUTPUT
            echo "ERROR: Terraform plan failed"
            exit 1
          fi

      - name: Upload Drift Report
        if: steps.drift.outputs.drift_detected == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: drift-report-prod
          path: ${{ env.TF_WORKING_DIR }}/drift-output.txt

      - name: Create GitHub Issue on Drift
        if: steps.drift.outputs.drift_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const driftOutput = fs.readFileSync('${{ env.TF_WORKING_DIR }}/drift-output.txt', 'utf8');
            const truncatedOutput = driftOutput.length > 60000
              ? driftOutput.substring(0, 60000) + '\n\n... (truncated)'
              : driftOutput;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® CRITICAL: Terraform Drift Detected (Production)',
              labels: ['drift', 'infrastructure', 'production', 'priority:critical'],
              assignees: ['@devops-team'],
              body: `## Infrastructure Drift Detected

**Environment**: Production
**Detected**: ${new Date().toISOString()}
**Workflow**: [${context.workflow}](${context.payload.repository.html_url}/actions/runs/${context.runId})

‚ö†Ô∏è **CRITICAL**: Production infrastructure has drifted from desired state!

### Drift Details

<details><summary>Show Terraform Plan</summary>

\`\`\`terraform
${truncatedOutput}
\`\`\`

</details>

### Immediate Action Required

1. **URGENT**: Review the drift details above
2. Determine if drift is expected or requires immediate remediation
3. If expected: Update Terraform configuration to match
4. If unexpected: Investigate and restore to desired state immediately
5. Document the incident and resolution
6. Close this issue once resolved

**Note**: Automated drift detection runs every 6 hours.
`
            });

  # ---------------------------------------------------------------------------
  # Notify on Completion
  # ---------------------------------------------------------------------------
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [drift-dev, drift-staging, drift-prod]
    if: always()
    steps:
      - name: Drift Summary
        run: |
          echo "Drift Detection Complete"
          echo "Dev: ${{ needs.drift-dev.result }}"
          echo "Staging: ${{ needs.drift-staging.result }}"
          echo "Prod: ${{ needs.drift-prod.result }}"
