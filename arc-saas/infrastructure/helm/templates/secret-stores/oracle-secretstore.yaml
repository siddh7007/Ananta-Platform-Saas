# =============================================================================
# Oracle Cloud Vault - ClusterSecretStore
# =============================================================================
# Prerequisites:
# 1. Install External Secrets Operator
# 2. Configure OCI instance principal or API key authentication
# 3. Create secrets in OCI Vault with path: arc-saas/<secret-name>
# =============================================================================
{{- if and .Values.global.secrets.provider (eq .Values.global.secrets.provider "external-secrets") }}
{{- if eq .Values.global.secrets.externalSecretsBackend "oracle-vault" }}
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: arc-saas-secret-store
spec:
  provider:
    oracle:
      vault: {{ .Values.oracle.vaultOCID | required "oracle.vaultOCID is required" }}
      region: {{ .Values.oracle.region | required "oracle.region is required" }}
      {{- if .Values.oracle.compartmentOCID }}
      compartment: {{ .Values.oracle.compartmentOCID }}
      {{- end }}
      {{- if .Values.oracle.useInstancePrincipal }}
      # Instance Principal - Recommended for OKE
      principalType: InstancePrincipal
      {{- else if .Values.oracle.apiKeySecret }}
      # API Key Authentication
      auth:
        tenancy: {{ .Values.oracle.tenancy | required "oracle.tenancy is required" }}
        user: {{ .Values.oracle.user | required "oracle.user is required" }}
        secretRef:
          privatekey:
            name: {{ .Values.oracle.apiKeySecret }}
            key: private-key
            namespace: {{ .Values.oracle.apiKeySecretNamespace | default "external-secrets" }}
          fingerprint:
            name: {{ .Values.oracle.apiKeySecret }}
            key: fingerprint
            namespace: {{ .Values.oracle.apiKeySecretNamespace | default "external-secrets" }}
      {{- end }}
{{- end }}
{{- end }}
