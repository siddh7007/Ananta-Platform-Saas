# =============================================================================
# HashiCorp Vault - ClusterSecretStore
# =============================================================================
# Prerequisites:
# 1. Install External Secrets Operator
# 2. Configure Vault with Kubernetes auth method or AppRole
# 3. Create secrets in Vault with path: arc-saas/<secret-name>
# =============================================================================
{{- if and .Values.global.secrets.provider (eq .Values.global.secrets.provider "vault") }}
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: arc-saas-secret-store
spec:
  provider:
    vault:
      server: {{ .Values.vault.address | required "vault.address is required" }}
      path: {{ .Values.vault.secretsPath | default "secret" }}
      version: {{ .Values.vault.kvVersion | default "v2" }}
      {{- if .Values.vault.namespace }}
      namespace: {{ .Values.vault.namespace }}
      {{- end }}
      {{- if .Values.vault.caBundle }}
      caBundle: {{ .Values.vault.caBundle }}
      {{- end }}
      {{- if .Values.vault.useKubernetesAuth }}
      # Kubernetes Auth - Recommended
      auth:
        kubernetes:
          mountPath: {{ .Values.vault.kubernetesAuthPath | default "kubernetes" }}
          role: {{ .Values.vault.kubernetesRole | required "vault.kubernetesRole is required for Kubernetes auth" }}
          {{- if .Values.vault.serviceAccountRef }}
          serviceAccountRef:
            name: {{ .Values.vault.serviceAccountRef.name }}
            namespace: {{ .Values.vault.serviceAccountRef.namespace | default "default" }}
          {{- end }}
      {{- else if .Values.vault.useAppRole }}
      # AppRole Auth
      auth:
        appRole:
          path: {{ .Values.vault.appRolePath | default "approle" }}
          roleId: {{ .Values.vault.appRoleId | required "vault.appRoleId is required for AppRole auth" }}
          secretRef:
            name: {{ .Values.vault.appRoleSecretRef.name | required "vault.appRoleSecretRef.name is required" }}
            key: {{ .Values.vault.appRoleSecretRef.key | default "secret-id" }}
            namespace: {{ .Values.vault.appRoleSecretRef.namespace | default "external-secrets" }}
      {{- else if .Values.vault.useTokenAuth }}
      # Token Auth - NOT recommended for production
      auth:
        tokenSecretRef:
          name: {{ .Values.vault.tokenSecretRef.name | required "vault.tokenSecretRef.name is required" }}
          key: {{ .Values.vault.tokenSecretRef.key | default "token" }}
          namespace: {{ .Values.vault.tokenSecretRef.namespace | default "external-secrets" }}
      {{- end }}
{{- end }}
