# =============================================================================
# GCP Secret Manager - ClusterSecretStore
# =============================================================================
# Prerequisites:
# 1. Install External Secrets Operator
# 2. Configure Workload Identity or service account key
# 3. Create secrets in GCP Secret Manager with path: arc-saas/<secret-name>
# =============================================================================
{{- if and .Values.global.secrets.provider (eq .Values.global.secrets.provider "external-secrets") }}
{{- if eq .Values.global.secrets.externalSecretsBackend "gcp-secretmanager" }}
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: arc-saas-secret-store
spec:
  provider:
    gcpsm:
      projectID: {{ .Values.gcp.projectId | required "gcp.projectId is required" }}
      {{- if .Values.gcp.serviceAccountSecret }}
      # Service Account Key - NOT recommended for production
      auth:
        secretRef:
          secretAccessKeySecretRef:
            name: {{ .Values.gcp.serviceAccountSecret }}
            key: service-account-key
            namespace: {{ .Values.gcp.serviceAccountSecretNamespace | default "external-secrets" }}
      {{- else }}
      # Workload Identity - Recommended for GKE
      auth:
        workloadIdentity:
          clusterLocation: {{ .Values.gcp.clusterLocation | required "gcp.clusterLocation is required for Workload Identity" }}
          clusterName: {{ .Values.gcp.clusterName | required "gcp.clusterName is required for Workload Identity" }}
          clusterProjectID: {{ .Values.gcp.clusterProjectId | default .Values.gcp.projectId }}
          serviceAccountRef:
            name: {{ .Values.gcp.serviceAccountName | default "external-secrets-sa" }}
            namespace: {{ .Values.gcp.serviceAccountNamespace | default "external-secrets" }}
      {{- end }}
{{- end }}
{{- end }}
