# Ananta Platform SaaS - Architecture Diagrams

## 1. High-Level Platform Overview

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                              ANANTA PLATFORM SAAS                                       │
│                         Multi-Tenant SaaS Control + App Plane                           │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                                    ┌─────────────┐
                                    │   USERS     │
                                    └──────┬──────┘
                                           │
                    ┌──────────────────────┼──────────────────────┐
                    │                      │                      │
                    ▼                      ▼                      ▼
           ┌───────────────┐      ┌───────────────┐      ┌───────────────┐
           │  SaaS Admin   │      │ Tenant Admin  │      │  Tenant User  │
           │  (Platform)   │      │  (Customer)   │      │  (End User)   │
           └───────┬───────┘      └───────┬───────┘      └───────┬───────┘
                   │                      │                      │
                   ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                              🌐 TRAEFIK API GATEWAY                                     │
│                                   :80 / :443                                            │
│                                                                                         │
│   ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────────────┐   │
│   │ /admin/*            │  │ /portal/*           │  │ /app/*                      │   │
│   │ → Admin Portal      │  │ → Customer Portal   │  │ → Components App            │   │
│   └─────────────────────┘  └─────────────────────┘  └─────────────────────────────┘   │
│                                                                                         │
│   ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────────────┐   │
│   │ /api/control/*      │  │ /api/app/*          │  │ /auth/*                     │   │
│   │ → Control Plane API │  │ → App Plane API     │  │ → Keycloak                  │   │
│   └─────────────────────┘  └─────────────────────┘  └─────────────────────────────┘   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                           │
                    ┌──────────────────────┴──────────────────────┐
                    │                                             │
                    ▼                                             ▼
┌─────────────────────────────────────────┐  ┌─────────────────────────────────────────┐
│                                         │  │                                         │
│         🎛️ CONTROL PLANE                │  │           📦 APP PLANE                  │
│           (ARC SaaS)                    │  │      (Components Platform V2)           │
│                                         │  │                                         │
│   • Tenant Management                   │  │   • Component Catalog                   │
│   • Subscription & Billing              │  │   • BOM Management                      │
│   • User Provisioning                   │  │   • Alerts & Monitoring                 │
│   • Plan Configuration                  │  │   • Vendor Data Integration             │
│   • Platform Administration             │  │   • AI-Powered Normalization            │
│                                         │  │                                         │
└─────────────────────────────────────────┘  └─────────────────────────────────────────┘
                    │                                             │
                    └──────────────────────┬──────────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                           🔧 SHARED INFRASTRUCTURE                                      │
│                                                                                         │
│   ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│   │PostgreSQL│ │  Redis   │ │ Keycloak │ │ Temporal │ │   Novu   │ │  MinIO   │       │
│   │  :5432   │ │  :6379   │ │  :8180   │ │  :7233   │ │  :3000   │ │  :9000   │       │
│   └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
│                                                                                         │
│   ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐                                  │
│   │Prometheus│ │ Grafana  │ │   Loki   │ │  Jaeger  │    📊 Observability Stack       │
│   │  :9090   │ │  :3000   │ │  :3100   │ │ :16686   │                                  │
│   └──────────┘ └──────────┘ └──────────┘ └──────────┘                                  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Control Plane Architecture (ARC SaaS)

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                           🎛️ CONTROL PLANE - ARC SAAS                                  │
│                              (Tenant Management Layer)                                  │
│                                                                                         │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                              FRONTEND LAYER                                      │  │
│   ├─────────────────────────────────────────────────────────────────────────────────┤  │
│   │                                                                                  │  │
│   │  ┌─────────────────────────────┐    ┌─────────────────────────────┐            │  │
│   │  │     🖥️ ADMIN PORTAL         │    │    🖥️ CUSTOMER PORTAL       │            │  │
│   │  │     (React + Refine)        │    │    (React + React Query)    │            │  │
│   │  │         :5000               │    │         :4000               │            │  │
│   │  ├─────────────────────────────┤    ├─────────────────────────────┤            │  │
│   │  │ • Tenant Management         │    │ • Subscription View         │            │  │
│   │  │ • Plan Configuration        │    │ • Team Management           │            │  │
│   │  │ • Subscription Overview     │    │ • Billing & Invoices        │            │  │
│   │  │ • Lead Management           │    │ • Account Settings          │            │  │
│   │  │ • Workflow Monitoring       │    │ • Usage Dashboard           │            │  │
│   │  │ • Invoice Management        │    │                             │            │  │
│   │  │ • Analytics Dashboard       │    │                             │            │  │
│   │  └─────────────────────────────┘    └─────────────────────────────┘            │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                          │                                             │
│                                          ▼                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                              BACKEND LAYER                                       │  │
│   ├─────────────────────────────────────────────────────────────────────────────────┤  │
│   │                                                                                  │  │
│   │  ┌─────────────────────────────────────────────────────────────────────────┐   │  │
│   │  │                    TENANT MANAGEMENT SERVICE                             │   │  │
│   │  │                    (LoopBack 4 + TypeScript)                             │   │  │
│   │  │                           :14000                                         │   │  │
│   │  ├─────────────────────────────────────────────────────────────────────────┤   │  │
│   │  │                                                                          │   │  │
│   │  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐   │   │  │
│   │  │  │    Tenant    │ │     Lead     │ │Subscription  │ │    Plan      │   │   │  │
│   │  │  │  Controller  │ │  Controller  │ │ Controller   │ │ Controller   │   │   │  │
│   │  │  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘   │   │  │
│   │  │                                                                          │   │  │
│   │  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐   │   │  │
│   │  │  │   Invoice    │ │     User     │ │  Settings    │ │   Workflow   │   │   │  │
│   │  │  │  Controller  │ │  Controller  │ │ Controller   │ │ Controller   │   │   │  │
│   │  │  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘   │   │  │
│   │  │                                                                          │   │  │
│   │  │  ┌─────────────────────────────────────────────────────────────────┐   │   │  │
│   │  │  │                         SERVICES                                 │   │   │  │
│   │  │  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌───────────┐ │   │   │  │
│   │  │  │  │ Onboarding  │ │Provisioning │ │  Temporal   │ │   Novu    │ │   │   │  │
│   │  │  │  │   Service   │ │   Service   │ │   Client    │ │  Notify   │ │   │   │  │
│   │  │  │  └─────────────┘ └─────────────┘ └─────────────┘ └───────────┘ │   │   │  │
│   │  │  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │   │   │  │
│   │  │  │  │    IDP      │ │ Invitation  │ │  Activity   │               │   │   │  │
│   │  │  │  │   Helper    │ │   Service   │ │   Logger    │               │   │   │  │
│   │  │  │  └─────────────┘ └─────────────┘ └─────────────┘               │   │   │  │
│   │  │  └─────────────────────────────────────────────────────────────────┘   │   │  │
│   │  │                                                                          │   │  │
│   │  └─────────────────────────────────────────────────────────────────────────┘   │  │
│   │                                                                                  │  │
│   │  ┌─────────────────────────────┐    ┌─────────────────────────────┐            │  │
│   │  │   SUBSCRIPTION SERVICE      │    │   TEMPORAL WORKER SERVICE   │            │  │
│   │  │   (LoopBack 4) :14001       │    │   (Node.js) - Background    │            │  │
│   │  ├─────────────────────────────┤    ├─────────────────────────────┤            │  │
│   │  │ • Plan Management           │    │ • Provisioning Workflow     │            │  │
│   │  │ • Billing Cycles            │    │ • Onboarding Workflow       │            │  │
│   │  │ • Usage Tracking            │    │ • Cleanup Workflow          │            │  │
│   │  │ • Invoice Generation        │    │ • Notification Workflow     │            │  │
│   │  └─────────────────────────────┘    └─────────────────────────────┘            │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                          │                                             │
│                                          ▼                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                              DATA LAYER                                          │  │
│   ├─────────────────────────────────────────────────────────────────────────────────┤  │
│   │                                                                                  │  │
│   │  PostgreSQL (arc_saas database)                                                 │  │
│   │  ┌─────────────────────────────────────────────────────────────────────────┐   │  │
│   │  │  Schema: tenant_management                                               │   │  │
│   │  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐           │   │  │
│   │  │  │  tenants   │ │   leads    │ │   plans    │ │ invoices   │           │   │  │
│   │  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘           │   │  │
│   │  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐           │   │  │
│   │  │  │   users    │ │user_tenants│ │ settings   │ │ workflows  │           │   │  │
│   │  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘           │   │  │
│   │  │  ┌────────────┐ ┌────────────┐ ┌────────────┐                          │   │  │
│   │  │  │subscriptions│ │ addresses │ │ contacts   │                          │   │  │
│   │  │  └────────────┘ └────────────┘ └────────────┘                          │   │  │
│   │  └─────────────────────────────────────────────────────────────────────────┘   │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. App Plane Architecture (Components Platform V2)

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                        📦 APP PLANE - COMPONENTS PLATFORM V2                            │
│                           (BOM & Component Management)                                  │
│                                                                                         │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                              FRONTEND LAYER                                      │  │
│   ├─────────────────────────────────────────────────────────────────────────────────┤  │
│   │                                                                                  │  │
│   │  ┌─────────────────────────────┐    ┌─────────────────────────────┐            │  │
│   │  │   🖥️ CUSTOMER PORTAL        │    │   🖥️ BACKSTAGE PORTAL       │            │  │
│   │  │   (React Admin + Vite)      │    │   (React Admin)             │            │  │
│   │  │        :27510               │    │        :27530               │            │  │
│   │  ├─────────────────────────────┤    ├─────────────────────────────┤            │  │
│   │  │ • BOM Upload & Management   │    │ • Component Normalization   │            │  │
│   │  │ • Component Search          │    │ • Enrichment Queue          │            │  │
│   │  │ • Alert Dashboard           │    │ • Admin Overrides           │            │  │
│   │  │ • Project Organization      │    │ • Conflict Resolution       │            │  │
│   │  │ • Team Collaboration        │    │ • System Monitoring         │            │  │
│   │  └─────────────────────────────┘    └─────────────────────────────┘            │  │
│   │                                                                                  │  │
│   │  ┌─────────────────────────────┐                                               │  │
│   │  │   📊 ANALYTICS DASHBOARD    │                                               │  │
│   │  │   (Next.js 14)              │                                               │  │
│   │  ├─────────────────────────────┤                                               │  │
│   │  │ • Usage Metrics             │                                               │  │
│   │  │ • Workflow Monitoring       │                                               │  │
│   │  │ • Cost Analytics            │                                               │  │
│   │  └─────────────────────────────┘                                               │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                          │                                             │
│                                          ▼                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                              BACKEND LAYER                                       │  │
│   ├─────────────────────────────────────────────────────────────────────────────────┤  │
│   │                                                                                  │  │
│   │  ┌───────────────────────────────────────────────────────────────────────────┐ │  │
│   │  │                      DJANGO BACKEND SERVICE                                │ │  │
│   │  │                      (Django 4.2 + DRF)                                    │ │  │
│   │  │                           :27510                                           │ │  │
│   │  ├───────────────────────────────────────────────────────────────────────────┤ │  │
│   │  │                                                                            │ │  │
│   │  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐         │ │  │
│   │  │  │ Component   │ │    BOM      │ │   Alert     │ │    User     │         │ │  │
│   │  │  │  ViewSet    │ │  ViewSet    │ │  ViewSet    │ │  ViewSet    │         │ │  │
│   │  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘         │ │  │
│   │  │                                                                            │ │  │
│   │  │  ┌───────────────────────────────────────────────────────────────────┐   │ │  │
│   │  │  │                      MIDDLEWARE                                    │   │ │  │
│   │  │  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐   │   │ │  │
│   │  │  │  │ TenantMiddleware│  │ LoggingMiddleware│ │ CORSMiddleware  │   │   │ │  │
│   │  │  │  │ (Multi-tenant)  │  │ (Correlation ID) │ │                 │   │   │ │  │
│   │  │  │  └─────────────────┘  └─────────────────┘  └─────────────────┘   │   │ │  │
│   │  │  └───────────────────────────────────────────────────────────────────┘   │ │  │
│   │  │                                                                            │ │  │
│   │  └───────────────────────────────────────────────────────────────────────────┘ │  │
│   │                                                                                  │  │
│   │  ┌─────────────────────────────┐    ┌─────────────────────────────┐            │  │
│   │  │   🧠 CNS SERVICE            │    │   🔄 MIDDLEWARE API          │            │  │
│   │  │   (FastAPI)                 │    │   (Flask)                    │            │  │
│   │  │        :27021               │    │        :27520                │            │  │
│   │  ├─────────────────────────────┤    ├─────────────────────────────┤            │  │
│   │  │ • AI Normalization (Claude) │    │ • Service Orchestration     │            │  │
│   │  │ • Parameter Extraction      │    │ • Cross-service Routing     │            │  │
│   │  │ • Category Mapping          │    │ • Request Aggregation       │            │  │
│   │  │ • Quality Scoring           │    │                             │            │  │
│   │  └─────────────────────────────┘    └─────────────────────────────┘            │  │
│   │                                                                                  │  │
│   │  ┌─────────────────────────────┐    ┌─────────────────────────────┐            │  │
│   │  │   ⚡ TEMPORAL WORKERS        │    │   📨 NOVU CONSUMER           │            │  │
│   │  │   (Python)                  │    │   (Python)                   │            │  │
│   │  ├─────────────────────────────┤    ├─────────────────────────────┤            │  │
│   │  │ • BOM Enrichment Workflow   │    │ • Alert Notifications       │            │  │
│   │  │ • Component Sync Workflow   │    │ • Email/SMS/Push            │            │  │
│   │  │ • Vendor Data Fetch         │    │ • In-app Notifications      │            │  │
│   │  │ • Price Update Workflow     │    │                             │            │  │
│   │  └─────────────────────────────┘    └─────────────────────────────┘            │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                          │                                             │
│                                          ▼                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                              DATA LAYER                                          │  │
│   ├─────────────────────────────────────────────────────────────────────────────────┤  │
│   │                                                                                  │  │
│   │  Supabase (PostgreSQL + Auth + RLS)                                             │  │
│   │  ┌─────────────────────────────────────────────────────────────────────────┐   │  │
│   │  │  Row-Level Security: organization_id = auth.jwt()->>'organization_id'    │   │  │
│   │  │                                                                          │   │  │
│   │  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐           │   │  │
│   │  │  │organizations│ │   users    │ │ components │ │    boms    │           │   │  │
│   │  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘           │   │  │
│   │  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐           │   │  │
│   │  │  │bom_line_   │ │  alerts    │ │  vendors   │ │  projects  │           │   │  │
│   │  │  │  items     │ │            │ │            │ │            │           │   │  │
│   │  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘           │   │  │
│   │  │  ┌────────────┐ ┌────────────┐ ┌────────────┐                          │   │  │
│   │  │  │enrichment_ │ │ audit_logs │ │notification│                          │   │  │
│   │  │  │  queue     │ │            │ │_preferences│                          │   │  │
│   │  │  └────────────┘ └────────────┘ └────────────┘                          │   │  │
│   │  └─────────────────────────────────────────────────────────────────────────┘   │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Integration Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                         🔗 CONTROL PLANE ↔ APP PLANE INTEGRATION                        │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                              NEW CUSTOMER SIGNUP FLOW
                              ========================

    ┌─────────┐
    │  Lead   │
    │ Signs Up│
    └────┬────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│  STEP 1: Lead Registration (Control Plane)                                              │
│  ═══════════════════════════════════════════                                            │
│                                                                                         │
│    ┌──────────────────┐         ┌──────────────────┐                                   │
│    │  Customer Portal │ ──────▶ │ Lead Controller  │                                   │
│    │  (React :4000)   │  POST   │ /api/leads       │                                   │
│    └──────────────────┘ /leads  └────────┬─────────┘                                   │
│                                          │                                              │
│                                          ▼                                              │
│                                 ┌──────────────────┐                                   │
│                                 │  OnboardingService│                                   │
│                                 │  - Create Lead    │                                   │
│                                 │  - Send Verify    │                                   │
│                                 │    Email (Novu)   │                                   │
│                                 └──────────────────┘                                   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
         │
         │ Email Verification
         ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│  STEP 2: Tenant Creation (Control Plane)                                                │
│  ═══════════════════════════════════════════                                            │
│                                                                                         │
│    ┌──────────────────┐         ┌──────────────────┐                                   │
│    │  Lead Verifies   │ ──────▶ │ Tenant Controller│                                   │
│    │  Email           │  POST   │ /api/tenants     │                                   │
│    └──────────────────┘/tenants └────────┬─────────┘                                   │
│                                          │                                              │
│                                          ▼                                              │
│                                 ┌──────────────────┐                                   │
│                                 │ProvisioningService│                                   │
│                                 │ - Create Tenant   │                                   │
│                                 │ - Select Plan     │                                   │
│                                 │ - Start Workflow  │                                   │
│                                 └────────┬─────────┘                                   │
│                                          │                                              │
│                                          ▼                                              │
│                                 ┌──────────────────┐                                   │
│                                 │  Temporal Client │                                   │
│                                 │ startWorkflow()   │                                   │
│                                 └────────┬─────────┘                                   │
│                                          │                                              │
└──────────────────────────────────────────┼──────────────────────────────────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│  STEP 3: Provisioning Workflow (Temporal)                                               │
│  ═════════════════════════════════════════                                              │
│                                                                                         │
│    ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│    │                        TENANT PROVISIONING WORKFLOW                              │ │
│    │                        Namespace: arc-saas                                       │ │
│    │                        Workflow ID: provision-tenant-{tenantId}                  │ │
│    ├─────────────────────────────────────────────────────────────────────────────────┤ │
│    │                                                                                  │ │
│    │   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   │ │
│    │   │   Activity   │   │   Activity   │   │   Activity   │   │   Activity   │   │ │
│    │   │ createIdpUser│──▶│createIdpRealm│──▶│ provisionApp │──▶│sendWelcome   │   │ │
│    │   │  (Keycloak)  │   │  (Keycloak)  │   │   Plane      │   │   Email      │   │ │
│    │   └──────────────┘   └──────────────┘   └──────┬───────┘   └──────────────┘   │ │
│    │                                                │                               │ │
│    └────────────────────────────────────────────────┼───────────────────────────────┘ │
│                                                     │                                  │
└─────────────────────────────────────────────────────┼──────────────────────────────────┘
                                                      │
                          ┌───────────────────────────┘
                          │
                          │  WEBHOOK / API CALL
                          │  POST /api/bootstrap
                          ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│  STEP 4: App Plane Provisioning (Components Platform)                                   │
│  ════════════════════════════════════════════════════                                   │
│                                                                                         │
│    ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│    │                         BOOTSTRAP ENDPOINT                                       │ │
│    │                         POST /api/bootstrap                                      │ │
│    ├─────────────────────────────────────────────────────────────────────────────────┤ │
│    │                                                                                  │ │
│    │   Request Body:                                                                 │ │
│    │   {                                                                             │ │
│    │     "tenantId": "uuid-from-control-plane",                                      │ │
│    │     "tenantKey": "acme-corp",                                                   │ │
│    │     "tenantName": "ACME Corporation",                                           │ │
│    │     "planId": "plan-professional",                                              │ │
│    │     "adminUser": {                                                              │ │
│    │       "email": "admin@acme.com",                                                │ │
│    │       "firstName": "John",                                                      │ │
│    │       "lastName": "Doe"                                                         │ │
│    │     },                                                                          │ │
│    │     "limits": {                                                                 │ │
│    │       "maxUsers": 25,                                                           │ │
│    │       "maxComponents": 50000,                                                   │ │
│    │       "maxStorageGb": 100                                                       │ │
│    │     }                                                                           │ │
│    │   }                                                                             │ │
│    │                                                                                  │ │
│    └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                          │                                              │
│                                          ▼                                              │
│    ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│    │                         DJANGO BOOTSTRAP SERVICE                                 │ │
│    ├─────────────────────────────────────────────────────────────────────────────────┤ │
│    │                                                                                  │ │
│    │   1. Create Organization in Supabase                                            │ │
│    │      ┌─────────────────────────────────────────────┐                           │ │
│    │      │ INSERT INTO organizations (                 │                           │ │
│    │      │   id, name, slug,                           │                           │ │
│    │      │   arc_saas_tenant_id,  -- Link to control   │                           │ │
│    │      │   max_users, max_components, max_storage_gb │                           │ │
│    │      │ ) VALUES (...)                              │                           │ │
│    │      └─────────────────────────────────────────────┘                           │ │
│    │                                                                                  │ │
│    │   2. Create Admin User                                                          │ │
│    │      ┌─────────────────────────────────────────────┐                           │ │
│    │      │ - Create Auth0 user in org                  │                           │ │
│    │      │ - Create users record with org_id           │                           │ │
│    │      │ - Assign 'owner' role                       │                           │ │
│    │      └─────────────────────────────────────────────┘                           │ │
│    │                                                                                  │ │
│    │   3. Initialize Default Data                                                    │ │
│    │      ┌─────────────────────────────────────────────┐                           │ │
│    │      │ - Create default project                    │                           │ │
│    │      │ - Set alert preferences                     │                           │ │
│    │      │ - Initialize feature flags by plan          │                           │ │
│    │      └─────────────────────────────────────────────┘                           │ │
│    │                                                                                  │ │
│    │   4. Return Success                                                             │ │
│    │      ┌─────────────────────────────────────────────┐                           │ │
│    │      │ { "status": "provisioned",                  │                           │ │
│    │      │   "organizationId": "uuid",                 │                           │ │
│    │      │   "portalUrl": "https://app.ananta.io/..." }│                           │ │
│    │      └─────────────────────────────────────────────┘                           │ │
│    │                                                                                  │ │
│    └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
         │
         │ Callback to Control Plane
         ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│  STEP 5: Complete Provisioning (Control Plane)                                          │
│  ════════════════════════════════════════════                                           │
│                                                                                         │
│    ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│    │                      UPDATE TENANT STATUS                                        │ │
│    ├─────────────────────────────────────────────────────────────────────────────────┤ │
│    │                                                                                  │ │
│    │   UPDATE tenants SET                                                            │ │
│    │     status = 'active',                                                          │ │
│    │     provisioned_at = NOW(),                                                     │ │
│    │     app_plane_org_id = 'uuid-from-components-platform'                          │ │
│    │   WHERE id = 'tenant-uuid';                                                     │ │
│    │                                                                                  │ │
│    └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                         │
│    ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│    │                      SEND WELCOME NOTIFICATION (Novu)                            │ │
│    ├─────────────────────────────────────────────────────────────────────────────────┤ │
│    │                                                                                  │ │
│    │   - Welcome email with login instructions                                       │ │
│    │   - Portal URL: https://app.ananta.io/{tenant-key}                              │ │
│    │   - Getting started guide                                                       │ │
│    │                                                                                  │ │
│    └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
    ┌─────────┐
    │ Tenant  │
    │ Active! │
    └─────────┘
```

---

## 5. Webhook Integration Events

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                         📡 WEBHOOK EVENTS BETWEEN PLANES                                │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────┐              ┌─────────────────────────────────┐
│       CONTROL PLANE             │              │         APP PLANE               │
│       (ARC SaaS)                │              │    (Components Platform)        │
└─────────────────────────────────┘              └─────────────────────────────────┘
               │                                                │
               │                                                │
               │  ════════════════════════════════════════════▶│
               │  EVENT: tenant.provisioned                     │
               │  ┌─────────────────────────────────────────┐  │
               │  │ POST /webhooks/tenant-provisioned       │  │
               │  │ {                                       │  │
               │  │   "event": "tenant.provisioned",        │  │
               │  │   "tenantId": "uuid",                   │  │
               │  │   "tenantKey": "acme-corp",             │  │
               │  │   "planId": "plan-professional",        │  │
               │  │   "limits": { ... }                     │  │
               │  │ }                                       │  │
               │  └─────────────────────────────────────────┘  │
               │                                                │
               │  ════════════════════════════════════════════▶│
               │  EVENT: subscription.changed                   │
               │  ┌─────────────────────────────────────────┐  │
               │  │ POST /webhooks/subscription-changed     │  │
               │  │ {                                       │  │
               │  │   "event": "subscription.changed",      │  │
               │  │   "tenantId": "uuid",                   │  │
               │  │   "previousPlan": "plan-basic",         │  │
               │  │   "newPlan": "plan-professional",       │  │
               │  │   "newLimits": {                        │  │
               │  │     "maxUsers": 25,                     │  │
               │  │     "maxComponents": 50000              │  │
               │  │   }                                     │  │
               │  │ }                                       │  │
               │  └─────────────────────────────────────────┘  │
               │                                                │
               │  ════════════════════════════════════════════▶│
               │  EVENT: subscription.cancelled                 │
               │  ┌─────────────────────────────────────────┐  │
               │  │ POST /webhooks/subscription-cancelled   │  │
               │  │ {                                       │  │
               │  │   "event": "subscription.cancelled",    │  │
               │  │   "tenantId": "uuid",                   │  │
               │  │   "effectiveDate": "2025-01-15",        │  │
               │  │   "action": "downgrade_to_free"         │  │
               │  │ }                                       │  │
               │  └─────────────────────────────────────────┘  │
               │                                                │
               │  ════════════════════════════════════════════▶│
               │  EVENT: user.invited                           │
               │  ┌─────────────────────────────────────────┐  │
               │  │ POST /webhooks/user-invited             │  │
               │  │ {                                       │  │
               │  │   "event": "user.invited",              │  │
               │  │   "tenantId": "uuid",                   │  │
               │  │   "userEmail": "new@acme.com",          │  │
               │  │   "role": "member"                      │  │
               │  │ }                                       │  │
               │  └─────────────────────────────────────────┘  │
               │                                                │
               │                                                │
               │◀════════════════════════════════════════════  │
               │  EVENT: usage.threshold_reached                │
               │  ┌─────────────────────────────────────────┐  │
               │  │ POST /webhooks/usage-alert              │  │
               │  │ {                                       │  │
               │  │   "event": "usage.threshold_reached",   │  │
               │  │   "tenantId": "uuid",                   │  │
               │  │   "metric": "components",               │  │
               │  │   "current": 45000,                     │  │
               │  │   "limit": 50000,                       │  │
               │  │   "percentage": 90                      │  │
               │  │ }                                       │  │
               │  └─────────────────────────────────────────┘  │
               │                                                │
               │◀════════════════════════════════════════════  │
               │  EVENT: billing.usage_report                   │
               │  ┌─────────────────────────────────────────┐  │
               │  │ POST /webhooks/usage-report             │  │
               │  │ {                                       │  │
               │  │   "event": "billing.usage_report",      │  │
               │  │   "tenantId": "uuid",                   │  │
               │  │   "period": "2025-01",                  │  │
               │  │   "usage": {                            │  │
               │  │     "apiCalls": 125000,                 │  │
               │  │     "storageGb": 45.2,                  │  │
               │  │     "bomProcessed": 89                  │  │
               │  │   }                                     │  │
               │  │ }                                       │  │
               │  └─────────────────────────────────────────┘  │
               │                                                │
               ▼                                                ▼
```

---

## 6. Shared Infrastructure Detail

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                          🔧 SHARED INFRASTRUCTURE DETAIL                                │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                              POSTGRESQL (SHARED)                                        │
│                              Container: platform-postgres                               │
│                              Port: 5432                                                 │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                                                                  │  │
│   │   Database: arc_saas (Control Plane)                                            │  │
│   │   ┌──────────────────────────────────────────────────────────────────────────┐ │  │
│   │   │  Schema: tenant_management                                                │ │  │
│   │   │  ├── tenants, leads, subscriptions, plans                                │ │  │
│   │   │  ├── invoices, users, user_tenants                                       │ │  │
│   │   │  └── settings, workflows, contacts                                       │ │  │
│   │   └──────────────────────────────────────────────────────────────────────────┘ │  │
│   │                                                                                  │  │
│   │   Database: keycloak (Shared Auth)                                              │  │
│   │   ┌──────────────────────────────────────────────────────────────────────────┐ │  │
│   │   │  Keycloak internal tables                                                 │ │  │
│   │   │  (realms, users, clients, roles, etc.)                                   │ │  │
│   │   └──────────────────────────────────────────────────────────────────────────┘ │  │
│   │                                                                                  │  │
│   │   Database: temporal (Workflow Engine)                                          │  │
│   │   ┌──────────────────────────────────────────────────────────────────────────┐ │  │
│   │   │  Temporal internal tables                                                 │ │  │
│   │   │  (namespaces, workflows, activities, etc.)                               │ │  │
│   │   └──────────────────────────────────────────────────────────────────────────┘ │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                                                                  │  │
│   │   Supabase Postgres (App Plane - Separate Instance)                             │  │
│   │   ┌──────────────────────────────────────────────────────────────────────────┐ │  │
│   │   │  Database: supabase (Port: 27810)                                        │ │  │
│   │   │  ├── organizations (linked to arc_saas.tenants)                          │ │  │
│   │   │  ├── users, components, boms, alerts                                     │ │  │
│   │   │  └── Row Level Security (RLS) enabled                                    │ │  │
│   │   └──────────────────────────────────────────────────────────────────────────┘ │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                              TEMPORAL (SHARED)                                          │
│                              Container: platform-temporal                               │
│                              Port: 7233                                                 │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                                                                  │  │
│   │   Namespace: arc-saas (Control Plane Workflows)                                 │  │
│   │   ┌──────────────────────────────────────────────────────────────────────────┐ │  │
│   │   │  Task Queue: tenant-provisioning                                          │ │  │
│   │   │  ├── TenantProvisioningWorkflow                                          │ │  │
│   │   │  ├── UserInvitationWorkflow                                              │ │  │
│   │   │  └── SubscriptionChangeWorkflow                                          │ │  │
│   │   └──────────────────────────────────────────────────────────────────────────┘ │  │
│   │                                                                                  │  │
│   │   Namespace: components-v2 (App Plane Workflows)                                │  │
│   │   ┌──────────────────────────────────────────────────────────────────────────┐ │  │
│   │   │  Task Queue: bom-enrichment                                               │ │  │
│   │   │  ├── BOMEnrichmentWorkflow                                               │ │  │
│   │   │  ├── ComponentSyncWorkflow                                               │ │  │
│   │   │  ├── PriceUpdateWorkflow                                                 │ │  │
│   │   │  └── VendorDataFetchWorkflow                                             │ │  │
│   │   └──────────────────────────────────────────────────────────────────────────┘ │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                              TEMPORAL UI                                         │  │
│   │                              Port: 8088                                          │  │
│   │   ┌──────────────────────────────────────────────────────────────────────────┐ │  │
│   │   │  • View all namespaces                                                    │ │  │
│   │   │  • Monitor workflow executions                                            │ │  │
│   │   │  • Inspect activities and events                                          │ │  │
│   │   │  • Terminate/retry workflows                                              │ │  │
│   │   └──────────────────────────────────────────────────────────────────────────┘ │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                              KEYCLOAK (SHARED)                                          │
│                              Container: platform-keycloak                               │
│                              Port: 8180                                                 │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                                                                  │  │
│   │   Realm: master                                                                 │  │
│   │   ┌──────────────────────────────────────────────────────────────────────────┐ │  │
│   │   │  • Platform administrators only                                           │ │  │
│   │   │  • Super admin access                                                     │ │  │
│   │   └──────────────────────────────────────────────────────────────────────────┘ │  │
│   │                                                                                  │  │
│   │   Realm: arc-saas                                                               │  │
│   │   ┌──────────────────────────────────────────────────────────────────────────┐ │  │
│   │   │  • Control plane users                                                    │ │  │
│   │   │  • Admin portal access                                                    │ │  │
│   │   │  • Customer portal access (tenant admins)                                 │ │  │
│   │   └──────────────────────────────────────────────────────────────────────────┘ │  │
│   │                                                                                  │  │
│   │   Realm: tenant-{tenantKey} (Per-Tenant - Auto Provisioned)                     │  │
│   │   ┌──────────────────────────────────────────────────────────────────────────┐ │  │
│   │   │  • Tenant-specific users                                                  │ │  │
│   │   │  • App plane access                                                       │ │  │
│   │   │  • Custom roles: owner, admin, member, viewer                             │ │  │
│   │   │  • SSO clients for Components Platform                                    │ │  │
│   │   └──────────────────────────────────────────────────────────────────────────┘ │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                              NOVU (SHARED)                                              │
│                              Notifications Hub                                          │
│                                                                                         │
│   ┌───────────────────┐  ┌───────────────────┐  ┌───────────────────┐                  │
│   │    NOVU API       │  │    NOVU WS        │  │   NOVU WORKER     │                  │
│   │     :13100        │  │     :13101        │  │   (Background)    │                  │
│   └───────────────────┘  └───────────────────┘  └───────────────────┘                  │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                         SUBSCRIBER ISOLATION                                     │  │
│   ├─────────────────────────────────────────────────────────────────────────────────┤  │
│   │                                                                                  │  │
│   │   Control Plane Subscribers:                                                    │  │
│   │   ┌──────────────────────────────────────────────────────────────────────────┐ │  │
│   │   │  • platform-admin-{userId}     → Platform notifications                   │ │  │
│   │   │  • tenant-admin-{tenantId}-{userId} → Tenant management alerts           │ │  │
│   │   └──────────────────────────────────────────────────────────────────────────┘ │  │
│   │                                                                                  │  │
│   │   App Plane Subscribers:                                                        │  │
│   │   ┌──────────────────────────────────────────────────────────────────────────┐ │  │
│   │   │  • app-{tenantId}-{userId}     → Component/BOM alerts                     │ │  │
│   │   │  • org-{orgId}-broadcast       → Org-wide announcements                   │ │  │
│   │   └──────────────────────────────────────────────────────────────────────────┘ │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                         NOTIFICATION WORKFLOWS                                   │  │
│   ├─────────────────────────────────────────────────────────────────────────────────┤  │
│   │                                                                                  │  │
│   │   Control Plane Workflows:                                                      │  │
│   │   • tenant-welcome        → Welcome email after provisioning                    │  │
│   │   • subscription-change   → Plan upgrade/downgrade notification                 │  │
│   │   • invoice-generated     → New invoice notification                            │  │
│   │   • payment-failed        → Payment failure alert                               │  │
│   │                                                                                  │  │
│   │   App Plane Workflows:                                                          │  │
│   │   • component-eol         → End-of-life component alert                         │  │
│   │   • price-change          → Price change notification                           │  │
│   │   • bom-enriched          → BOM processing complete                             │  │
│   │   • supply-risk           → Supply chain risk alert                             │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                              OBSERVABILITY STACK (SHARED)                               │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                                                                  │  │
│   │   ┌───────────────┐    ┌───────────────┐    ┌───────────────┐                   │  │
│   │   │  PROMETHEUS   │    │    GRAFANA    │    │     LOKI      │                   │  │
│   │   │    :9090      │    │    :3000      │    │    :3100      │                   │  │
│   │   │               │    │               │    │               │                   │  │
│   │   │ Scrape:       │    │ Dashboards:   │    │ Log Sources:  │                   │  │
│   │   │ • All services│    │ • Platform    │    │ • All services│                   │  │
│   │   │ • Traefik     │    │ • Control     │    │ • Traefik     │                   │  │
│   │   │ • Temporal    │    │ • App Plane   │    │ • Temporal    │                   │  │
│   │   │ • Redis       │    │ • Temporal    │    │ • PostgreSQL  │                   │  │
│   │   │ • Postgres    │    │ • Custom      │    │               │                   │  │
│   │   └───────────────┘    └───────────────┘    └───────────────┘                   │  │
│   │                                                                                  │  │
│   │   ┌───────────────┐    ┌───────────────┐                                        │  │
│   │   │    JAEGER     │    │    TEMPO      │                                        │  │
│   │   │   :16686      │    │   :3200       │                                        │  │
│   │   │               │    │               │                                        │  │
│   │   │ Traces:       │    │ Long-term     │                                        │  │
│   │   │ • HTTP spans  │    │ trace storage │                                        │  │
│   │   │ • DB queries  │    │               │                                        │  │
│   │   │ • Workflows   │    │               │                                        │  │
│   │   └───────────────┘    └───────────────┘                                        │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Network Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                              🌐 NETWORK ARCHITECTURE                                    │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│   DOCKER NETWORK: platform-network (bridge)                                             │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                           EXTERNAL ACCESS (Traefik)                              │  │
│   │                                                                                  │  │
│   │                              ┌─────────────────┐                                │  │
│   │                              │    TRAEFIK      │                                │  │
│   │                              │   :80 / :443    │                                │  │
│   │                              └────────┬────────┘                                │  │
│   │                                       │                                          │  │
│   │              ┌────────────────────────┼────────────────────────┐                │  │
│   │              │                        │                        │                │  │
│   │              ▼                        ▼                        ▼                │  │
│   │     ┌───────────────┐       ┌───────────────┐       ┌───────────────┐          │  │
│   │     │ /admin/*      │       │ /api/control/*│       │ /api/app/*    │          │  │
│   │     │ Admin Portal  │       │ Control Plane │       │ App Plane     │          │  │
│   │     │   :5000       │       │   :14000      │       │   :27510      │          │  │
│   │     └───────────────┘       └───────────────┘       └───────────────┘          │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                           INTERNAL SERVICES                                      │  │
│   │                                                                                  │  │
│   │   ┌─────────────────────────────────────────────────────────────────────────┐  │  │
│   │   │                    SHARED INFRASTRUCTURE                                 │  │  │
│   │   │                                                                          │  │  │
│   │   │   postgres:5432    redis:6379    keycloak:8080    temporal:7233         │  │  │
│   │   │   minio:9000       novu-api:3000  jaeger:16686   prometheus:9090        │  │  │
│   │   │                                                                          │  │  │
│   │   └─────────────────────────────────────────────────────────────────────────┘  │  │
│   │                                                                                  │  │
│   │   ┌─────────────────────────────┐   ┌─────────────────────────────┐            │  │
│   │   │      CONTROL PLANE          │   │        APP PLANE             │            │  │
│   │   │                             │   │                              │            │  │
│   │   │  tenant-mgmt-svc:14000      │   │  django-backend:27510        │            │  │
│   │   │  subscription-svc:14001     │   │  cns-service:27021           │            │  │
│   │   │  temporal-worker:internal   │   │  middleware-api:27520        │            │  │
│   │   │  admin-portal:5000          │   │  customer-portal:27510       │            │  │
│   │   │  customer-app:4000          │   │  backstage-portal:27530      │            │  │
│   │   │                             │   │  temporal-workers:internal   │            │  │
│   │   │                             │   │  novu-consumer:internal      │            │  │
│   │   │                             │   │  supabase-db:27810           │            │  │
│   │   │                             │   │  rabbitmq:27250              │            │  │
│   │   └─────────────────────────────┘   └─────────────────────────────┘            │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                              PORT ALLOCATION STRATEGY
                              ========================

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│   SHARED INFRASTRUCTURE (Standard Ports)                                                │
│   ──────────────────────────────────────                                                │
│   5432      PostgreSQL (main)                                                           │
│   5433      PostgreSQL (Temporal)                                                       │
│   6379      Redis                                                                       │
│   7233      Temporal Server                                                             │
│   8088      Temporal UI                                                                 │
│   8180      Keycloak                                                                    │
│   9000-9001 MinIO (S3 API + Console)                                                    │
│   9090      Prometheus                                                                  │
│   3000      Grafana                                                                     │
│   3100      Loki                                                                        │
│   16686     Jaeger UI                                                                   │
│   27017     MongoDB (Novu)                                                              │
│   13100     Novu API                                                                    │
│   13101     Novu WebSocket                                                              │
│   14200     Novu Dashboard                                                              │
│                                                                                         │
│   CONTROL PLANE (14xxx Range)                                                           │
│   ───────────────────────────                                                           │
│   14000     Tenant Management Service                                                   │
│   14001     Subscription Service                                                        │
│   5000      Admin Portal                                                                │
│   4000      Customer App (Tenant Portal)                                                │
│                                                                                         │
│   APP PLANE (27xxx Range)                                                               │
│   ────────────────────────                                                              │
│   27010     PostgreSQL (Components)                                                     │
│   27012     Redis (Components)                                                          │
│   27020     Temporal (if separate)                                                      │
│   27021     CNS Service (FastAPI)                                                       │
│   27250     RabbitMQ                                                                    │
│   27500     Traefik HTTP                                                                │
│   27501     Traefik Dashboard                                                           │
│   27510     Django Backend / Customer Portal                                            │
│   27520     Middleware API                                                              │
│   27530     Backstage Portal                                                            │
│   27810     Supabase PostgreSQL                                                         │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Data Flow Summary

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                              📊 DATA FLOW SUMMARY                                       │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│   1. TENANT ONBOARDING                                                                  │
│   ════════════════════                                                                  │
│                                                                                         │
│   [Lead Signup] → [Email Verify] → [Plan Select] → [Provision Workflow]                 │
│        │              │                │                    │                           │
│        ▼              ▼                ▼                    ▼                           │
│   leads table    novu email      subscriptions      Temporal workflow                   │
│                                                            │                           │
│                                 ┌──────────────────────────┼─────────────────────┐     │
│                                 │                          │                     │     │
│                                 ▼                          ▼                     ▼     │
│                           Keycloak realm         App Plane bootstrap      Welcome email │
│                           (tenant-{key})         (organization)           (novu)       │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│   2. USER AUTHENTICATION                                                                │
│   ══════════════════════                                                                │
│                                                                                         │
│   [User Login] → [Keycloak] → [JWT Token] → [Control/App Plane API]                     │
│        │             │             │                   │                               │
│        │             │             │                   ├── Control Plane: /api/control/*│
│        │             │             │                   │   (tenant mgmt, billing)       │
│        │             │             │                   │                               │
│        │             │             │                   └── App Plane: /api/app/*        │
│        │             │             │                       (components, BOMs)           │
│        │             │             │                                                    │
│        │             │             └── JWT contains:                                    │
│        │             │                 • userId                                         │
│        │             │                 • tenantId                                       │
│        │             │                 • organizationId                                 │
│        │             │                 • permissions[]                                  │
│        │             │                                                                  │
│        │             └── Realm: tenant-{tenantKey}                                      │
│        │                                                                                │
│        └── Portal: app.ananta.io/{tenantKey}                                            │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│   3. SUBSCRIPTION CHANGES                                                               │
│   ═══════════════════════                                                               │
│                                                                                         │
│   [Plan Upgrade] → [Control Plane] → [Webhook] → [App Plane]                            │
│        │                 │               │             │                               │
│        ▼                 ▼               ▼             ▼                               │
│   Stripe payment    subscriptions   POST /webhook  Update limits                        │
│   processed         table update    /subscription  in organizations                     │
│                                     -changed       table                               │
│                                                                                         │
│   Limits Updated:                                                                       │
│   • maxUsers: 5 → 25                                                                    │
│   • maxComponents: 10000 → 50000                                                        │
│   • maxStorageGb: 10 → 100                                                              │
│   • Features unlocked: AI normalization, bulk export, etc.                              │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│   4. USAGE TRACKING & BILLING                                                           │
│   ═══════════════════════════                                                           │
│                                                                                         │
│   [App Plane Usage] → [Metrics Collected] → [Webhook] → [Control Plane]                 │
│        │                     │                  │              │                       │
│        │                     │                  │              ▼                       │
│        │                     │                  │         billing_events               │
│        │                     │                  │         table update                 │
│        │                     │                  │              │                       │
│        │                     │                  │              ▼                       │
│        │                     │                  │         Invoice generation           │
│        │                     │                  │         (monthly cycle)              │
│        │                     │                  │                                       │
│        │                     │                  └── POST /webhooks/usage-report         │
│        │                     │                      { apiCalls, storageGb, ... }        │
│        │                     │                                                          │
│        │                     └── Supabase analytics:                                    │
│        │                         • Component count per org                              │
│        │                         • BOM processing count                                 │
│        │                         • API call count                                       │
│        │                         • Storage usage                                        │
│        │                                                                                │
│        └── User actions: BOM upload, component search, etc.                             │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Summary: Integration Points

| Integration | Direction | Mechanism | Data Exchanged |
|-------------|-----------|-----------|----------------|
| Tenant Provisioning | Control → App | Temporal Activity | Tenant details, limits |
| Subscription Changes | Control → App | Webhook | New plan, limits |
| User Invitations | Control → App | Webhook | User email, role |
| Usage Reporting | App → Control | Webhook | Metrics, counts |
| Billing Events | App → Control | Webhook | Usage data |
| Authentication | Shared | Keycloak JWT | User identity, permissions |
| Notifications | Shared | Novu API | All notification types |
| Workflows | Shared | Temporal | Cross-plane activities |
| Observability | Shared | Prometheus/Loki | Metrics, logs, traces |
