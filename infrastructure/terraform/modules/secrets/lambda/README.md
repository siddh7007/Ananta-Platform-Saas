# Lambda Rotation Function

This directory contains the Lambda function code for AWS Secrets Manager rotation of PostgreSQL database credentials.

## Files

- `rotation.py` - Main rotation handler implementing the 4-step rotation process
- `rotation.zip` - Auto-generated by Terraform (archived rotation.py)
- `layers/psycopg2-layer.zip` - PostgreSQL driver layer (must be built manually)

## Building the psycopg2 Layer

The rotation Lambda requires the `psycopg2` library to connect to PostgreSQL. This must be packaged as a Lambda layer.

### Option 1: Using Docker (Recommended)

```bash
# Create layer directory
mkdir -p layers/python

# Build psycopg2 using AWS Lambda Python runtime container
docker run --rm -v "${PWD}/layers:/out" \
  public.ecr.aws/lambda/python:3.11 \
  /bin/bash -c "pip install psycopg2-binary -t /out/python && chmod -R 755 /out"

# Create layer zip
cd layers
zip -r psycopg2-layer.zip python/
cd ..

# Cleanup
rm -rf layers/python
```

### Option 2: Using Local Python (Linux/Mac)

```bash
# Create virtual environment
python3.11 -m venv venv
source venv/bin/activate

# Install psycopg2-binary
mkdir -p layers/python
pip install psycopg2-binary -t layers/python/

# Create layer zip
cd layers
zip -r psycopg2-layer.zip python/
cd ..

# Cleanup
deactivate
rm -rf venv layers/python
```

### Option 3: Download Pre-built Layer

AWS provides pre-built psycopg2 layers. You can reference them directly:

```hcl
# In main.tf, replace the aws_lambda_layer_version resource with:
data "aws_lambda_layer_version" "psycopg2" {
  layer_name = "psycopg2-py311"  # Adjust version as needed
}

# Update Lambda function to use:
layers = [data.aws_lambda_layer_version.psycopg2.arn]
```

## Rotation Process

The rotation follows AWS Secrets Manager's 4-step process:

### 1. createSecret
- Retrieves current secret
- Generates new 32-character password
- Stores new version with `AWSPENDING` stage

### 2. setSecret
- Connects to database with current password
- Executes `ALTER USER` with new password
- Validates command succeeded

### 3. testSecret
- Connects to database with new password
- Executes test query `SELECT 1`
- Validates connection works

### 4. finishSecret
- Moves `AWSCURRENT` stage to new version
- Old version becomes `AWSPREVIOUS`

## Environment Variables

The Lambda function uses these environment variables (set by Terraform):

- `SECRETS_MANAGER_ENDPOINT` - Secrets Manager API endpoint
- `AWS_REGION` - AWS region for API calls

## IAM Permissions Required

The rotation Lambda needs:

1. **Secrets Manager**:
   - `secretsmanager:DescribeSecret`
   - `secretsmanager:GetSecretValue`
   - `secretsmanager:PutSecretValue`
   - `secretsmanager:UpdateSecretVersionStage`
   - `secretsmanager:GetRandomPassword`

2. **CloudWatch Logs**:
   - `logs:CreateLogGroup`
   - `logs:CreateLogStream`
   - `logs:PutLogEvents`

3. **VPC (if deployed in VPC)**:
   - `ec2:CreateNetworkInterface`
   - `ec2:DeleteNetworkInterface`
   - `ec2:DescribeNetworkInterfaces`

4. **KMS (if secrets encrypted)**:
   - `kms:Decrypt`
   - `kms:GenerateDataKey`

5. **X-Ray (for tracing)**:
   - `xray:PutTraceSegments`
   - `xray:PutTelemetryRecords`

## Security Considerations

1. **Network Access**: Lambda must have network access to RDS instances
2. **Security Groups**: Ensure rotation Lambda SG is allowed on RDS port 5432
3. **Password Complexity**: Generated passwords are 32 chars, exclude special chars that break connection strings
4. **Rotation Window**: Default 30 days, configurable via Terraform variable
5. **Recovery Window**: 7-day recovery window for deleted secrets
6. **Logging**: All rotation steps logged to CloudWatch with `[ROTATION]` prefix

## Testing Rotation

### Manual Rotation Trigger
```bash
aws secretsmanager rotate-secret \
  --secret-id "ananta/dev/control-plane-db" \
  --region us-east-1
```

### Check Rotation Status
```bash
aws secretsmanager describe-secret \
  --secret-id "ananta/dev/control-plane-db" \
  --region us-east-1
```

### View Logs
```bash
aws logs tail /aws/lambda/dev-secrets-rotation \
  --follow \
  --region us-east-1
```

## Troubleshooting

### Rotation Fails at setSecret
- **Cause**: Lambda cannot connect to database
- **Fix**: Verify security group allows Lambda SG on port 5432
- **Check**: VPC configuration, subnet routing, NAT gateway

### Rotation Fails at testSecret
- **Cause**: New password not set correctly
- **Fix**: Check CloudWatch logs for SQL errors
- **Verify**: User has ALTER USER permissions

### Lambda Timeout
- **Cause**: Network latency, slow database
- **Fix**: Increase Lambda timeout (default 300s)
- **Check**: Database performance metrics

### Import Error: psycopg2
- **Cause**: Layer not built for Lambda runtime
- **Fix**: Rebuild layer using Docker method above
- **Verify**: Layer compatible with Python 3.11

## Monitoring

Rotation events emit CloudWatch metrics:

- `SecretsManagerRotation.Success` - Successful rotations
- `SecretsManagerRotation.Failure` - Failed rotations
- `SecretsManagerRotation.Duration` - Rotation duration

Set up alarms for rotation failures:
```bash
aws cloudwatch put-metric-alarm \
  --alarm-name "secrets-rotation-failures" \
  --alarm-description "Alert on secret rotation failures" \
  --metric-name "Errors" \
  --namespace "AWS/Lambda" \
  --statistic "Sum" \
  --period 300 \
  --evaluation-periods 1 \
  --threshold 1 \
  --comparison-operator "GreaterThanThreshold"
```
