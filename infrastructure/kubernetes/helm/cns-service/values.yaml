# =============================================================================
# Default values for cns-service (Component Normalization Service)
# =============================================================================

replicaCount: 2

image:
  repository: ghcr.io/ananta-platform/cns-service
  pullPolicy: IfNotPresent
  tag: ""

imagePullSecrets: []
nameOverride: ""
fullnameOverride: "cns-service"

serviceAccount:
  create: true
  annotations: {}
  name: ""

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "27200"
  prometheus.io/path: "/metrics"

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000
  seccompProfile:
    type: RuntimeDefault

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: true

service:
  type: ClusterIP
  port: 27200
  targetPort: 27200
  annotations: {}

ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-buffering: "off"  # Important for SSE
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
  hosts:
    - host: cns.ananta.local
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: cns-service-tls
      hosts:
        - cns.ananta.local

resources:
  limits:
    cpu: 1000m
    memory: 2Gi
  requests:
    cpu: 200m
    memory: 512Mi

autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 20
  targetCPUUtilizationPercentage: 60
  targetMemoryUtilizationPercentage: 70

nodeSelector: {}

tolerations: []

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - cns-service
          topologyKey: kubernetes.io/hostname

# Health probes
livenessProbe:
  httpGet:
    path: /health
    port: 27200
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  successThreshold: 1
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /health
    port: 27200
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  successThreshold: 1
  failureThreshold: 3

startupProbe:
  httpGet:
    path: /health
    port: 27200
  initialDelaySeconds: 0
  periodSeconds: 10
  timeoutSeconds: 3
  successThreshold: 1
  failureThreshold: 30

# Environment configuration
configMap:
  LOG_LEVEL: info
  PYTHON_ENV: production
  PORT: "27200"
  HOST: "0.0.0.0"
  ENABLE_STREAM_SSE: "true"
  ENRICHMENT_BATCH_SIZE: "50"
  ENRICHMENT_TIMEOUT: "300"

secrets:
  existingSecret: "cns-service-secrets"
  create: false
  data: {}

# Database configuration
databases:
  supabase:
    host: supabase-db.database-system.svc.cluster.local
    port: 5432
    database: postgres
  componentsV2:
    host: components-db.database-system.svc.cluster.local
    port: 5432
    database: components_v2

# Redis for caching
redis:
  host: redis.cache-system.svc.cluster.local
  port: 6379
  db: 0

# RabbitMQ for async processing
rabbitmq:
  host: rabbitmq.messaging-system.svc.cluster.local
  port: 5672
  vhost: cns
  queue: component-enrichment

# Temporal for workflows
temporal:
  address: temporal.temporal-system.svc.cluster.local:7233
  namespace: enrichment
  taskQueue: component-enrichment

# Service Monitor for Prometheus
serviceMonitor:
  enabled: true
  interval: 30s
  scrapeTimeout: 10s
  labels: {}
  honorLabels: true

podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Volumes
volumes:
  - name: tmp
    emptyDir: {}
  - name: cache
    emptyDir: {}

volumeMounts:
  - name: tmp
    mountPath: /tmp
  - name: cache
    mountPath: /app/.cache

extraEnv: []
extraEnvFrom: []
initContainers: []
sidecars: []
