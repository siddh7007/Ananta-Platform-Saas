# =============================================================================
# Coolify Production Deployment - Full Platform
# =============================================================================
#
# Complete Ananta Platform SaaS deployment combining:
#   - Control Plane (arc-saas): Tenant management, Keycloak, Novu
#   - App Plane: CNS Service, Django, Supabase, frontends
#
# Total: 47 services
#
# Services added:
#   - subscription-service: Billing/subscription management
#   - middleware-api: API gateway/middleware
#   - webhook-bridge: Control-to-App plane integration
#   - audit-logger: Audit logging (RabbitMQ consumer)
#   - novu-consumer: Notification consumer
#   - directus: Headless CMS
#   - dashboard: Unified dashboard frontend
#
# =============================================================================

services:
  # ===========================================================================
  # CONTROL PLANE - CORE INFRASTRUCTURE
  # ===========================================================================

  control-plane-postgres:
    image: postgres:15-alpine
    volumes:
      - control-plane-postgres-data:/var/lib/postgresql/data
      - ./migrations/000_init_databases.sql:/docker-entrypoint-initdb.d/000_init_databases.sql:ro
      - ./migrations/003_ARC_SAAS_MASTER.sql:/docker-entrypoint-initdb.d/001_arc_saas.sql:ro
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${CONTROL_PLANE_DB_PASSWORD}
      POSTGRES_DB: postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    labels:
      - coolify.managed=true

  control-plane-redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes --requirepass ${CONTROL_PLANE_REDIS_PASSWORD:-}
    volumes:
      - control-plane-redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    labels:
      - coolify.managed=true

  # ===========================================================================
  # CONTROL PLANE - KEYCLOAK
  # ===========================================================================

  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    command: start --optimized
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://control-plane-postgres:5432/keycloak
      KC_DB_USERNAME: postgres
      KC_DB_PASSWORD: ${CONTROL_PLANE_DB_PASSWORD}
      KC_HEALTH_ENABLED: "true"
      KC_HOSTNAME: ${KEYCLOAK_HOSTNAME:-auth.yourdomain.com}
      KC_PROXY: edge
      KC_HTTP_ENABLED: "true"
    depends_on:
      control-plane-postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=8080
      - coolify.name=keycloak

  # ===========================================================================
  # CONTROL PLANE - NOVU (Notifications)
  # ===========================================================================

  novu-mongodb:
    image: mongo:6
    volumes:
      - novu-mongo-data:/data/db
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  novu-redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - novu-redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  novu-api:
    image: ghcr.io/novuhq/novu/api:latest
    depends_on:
      - novu-mongodb
      - novu-redis
      - control-plane-minio
    environment:
      NODE_ENV: production
      API_ROOT_URL: ${NOVU_API_URL}
      DISABLE_USER_REGISTRATION: "false"
      PORT: 3000
      FRONT_BASE_URL: ${NOVU_WEB_URL}
      WIDGET_BASE_URL: ${NOVU_WEB_URL}
      MONGO_URL: mongodb://novu-mongodb:27017/novu-db
      REDIS_HOST: novu-redis
      REDIS_PORT: 6379
      S3_LOCAL_STACK: http://control-plane-minio:9000
      S3_BUCKET_NAME: novu-storage
      S3_REGION: us-east-1
      AWS_ACCESS_KEY_ID: ${CONTROL_PLANE_MINIO_USER}
      AWS_SECRET_ACCESS_KEY: ${CONTROL_PLANE_MINIO_PASSWORD}
      JWT_SECRET: ${NOVU_JWT_SECRET}
      STORE_ENCRYPTION_KEY: ${NOVU_ENCRYPTION_KEY}
      NOVU_SECRET_KEY: ${NOVU_SECRET_KEY}
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=3000
      - coolify.name=novu-api

  novu-ws:
    image: ghcr.io/novuhq/novu/ws:latest
    depends_on:
      - novu-mongodb
      - novu-redis
    environment:
      NODE_ENV: production
      PORT: 3002
      MONGO_URL: mongodb://novu-mongodb:27017/novu-db
      REDIS_HOST: novu-redis
      REDIS_PORT: 6379
      JWT_SECRET: ${NOVU_JWT_SECRET}
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=3002
      - coolify.name=novu-ws

  novu-worker:
    image: ghcr.io/novuhq/novu/worker:latest
    depends_on:
      - novu-api
    environment:
      NODE_ENV: production
      MONGO_URL: mongodb://novu-mongodb:27017/novu-db
      REDIS_HOST: novu-redis
      REDIS_PORT: 6379
      JWT_SECRET: ${NOVU_JWT_SECRET}
      STORE_ENCRYPTION_KEY: ${NOVU_ENCRYPTION_KEY}
      NOVU_SECRET_KEY: ${NOVU_SECRET_KEY}
      API_ROOT_URL: http://novu-api:3000
    restart: unless-stopped

  novu-web:
    image: ghcr.io/novuhq/novu/web:latest
    depends_on:
      - novu-api
    environment:
      REACT_APP_API_URL: ${NOVU_API_URL}
      REACT_APP_WS_URL: ${NOVU_WS_URL}
      API_ROOT_URL: http://novu-api:3000
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=4200
      - coolify.name=novu-dashboard

  # ===========================================================================
  # CONTROL PLANE - STORAGE & OBSERVABILITY
  # ===========================================================================

  control-plane-minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${CONTROL_PLANE_MINIO_USER}
      MINIO_ROOT_PASSWORD: ${CONTROL_PLANE_MINIO_PASSWORD}
    volumes:
      - control-plane-minio-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=9001
      - coolify.name=control-plane-minio

  control-plane-minio-init:
    image: minio/mc:latest
    depends_on:
      control-plane-minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://control-plane-minio:9000 $${CONTROL_PLANE_MINIO_USER} $${CONTROL_PLANE_MINIO_PASSWORD};
      mc mb myminio/arc-saas-tenants --ignore-existing;
      mc mb myminio/arc-saas-assets --ignore-existing;
      mc mb myminio/novu-storage --ignore-existing;
      exit 0;
      "
    environment:
      CONTROL_PLANE_MINIO_USER: ${CONTROL_PLANE_MINIO_USER}
      CONTROL_PLANE_MINIO_PASSWORD: ${CONTROL_PLANE_MINIO_PASSWORD}

  jaeger:
    image: jaegertracing/all-in-one:1.53
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=16686
      - coolify.name=jaeger-ui

  # ===========================================================================
  # SHARED - TEMPORAL (Workflow Engine)
  # ===========================================================================

  temporal-postgresql:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: temporal
      POSTGRES_PASSWORD: ${TEMPORAL_DB_PASSWORD}
      POSTGRES_DB: temporal
    volumes:
      - temporal-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U temporal"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  temporal:
    image: temporalio/auto-setup:1.24.2
    depends_on:
      temporal-postgresql:
        condition: service_healthy
    environment:
      DB: postgres12
      DB_PORT: 5432
      POSTGRES_USER: temporal
      POSTGRES_PWD: ${TEMPORAL_DB_PASSWORD}
      POSTGRES_SEEDS: temporal-postgresql
      ENABLE_ES: "false"
      # Auto-create namespaces on startup
      SKIP_DEFAULT_NAMESPACE_CREATION: "false"
      DEFAULT_NAMESPACE: default
      DEFAULT_NAMESPACE_RETENTION: 72h
    healthcheck:
      test: ["CMD-SHELL", "tctl cluster health || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 15
      start_period: 90s
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=7233

  # Temporal namespace initialization (runs once to create arc-saas and enrichment namespaces)
  temporal-init:
    image: temporalio/admin-tools:1.24.2
    depends_on:
      temporal:
        condition: service_healthy
    environment:
      TEMPORAL_ADDRESS: temporal:7233
    command: ["sh", "-c", "tctl --ns arc-saas namespace register --retention 72h || true; tctl --ns enrichment namespace register --retention 72h || true; tctl namespace list"]
    restart: "no"

  temporal-ui:
    image: temporalio/ui:2.26.2
    depends_on:
      - temporal
    environment:
      TEMPORAL_ADDRESS: temporal:7233
      TEMPORAL_CORS_ORIGINS: "*"
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=8080
      - coolify.name=temporal-ui

  # ===========================================================================
  # CONTROL PLANE - BACKEND SERVICES
  # ===========================================================================

  tenant-management-service:
    build:
      context: ../../arc-saas/services/tenant-management-service
      dockerfile: Dockerfile
    depends_on:
      control-plane-postgres:
        condition: service_healthy
      control-plane-redis:
        condition: service_healthy
    environment:
      NODE_ENV: production
      PORT: 14000
      HOST: 0.0.0.0
      DB_HOST: control-plane-postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: ${CONTROL_PLANE_DB_PASSWORD}
      DB_DATABASE: arc_saas
      DB_SCHEMA: main
      REDIS_HOST: control-plane-redis
      REDIS_PORT: 6379
      TEMPORAL_ADDRESS: temporal:7233
      TEMPORAL_NAMESPACE: arc-saas
      JWT_SECRET: ${JWT_SECRET}
      JWT_ISSUER: ${KEYCLOAK_URL}/realms/${KEYCLOAK_REALM}
      KEYCLOAK_ENABLED: "true"
      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_REALM: ${KEYCLOAK_REALM:-ananta-saas}
      NOVU_ENABLED: "true"
      NOVU_API_KEY: ${NOVU_API_KEY:-}
      NOVU_BACKEND_URL: http://novu-api:3000
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:14000/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=14000
      - coolify.name=tenant-api

  temporal-worker-service:
    build:
      context: ../../arc-saas/services/temporal-worker-service
      dockerfile: Dockerfile
    depends_on:
      temporal:
        condition: service_healthy
    environment:
      NODE_ENV: production
      TEMPORAL_ADDRESS: temporal:7233
      TEMPORAL_NAMESPACE: arc-saas
      TEMPORAL_TASK_QUEUE: tenant-provisioning
      DB_HOST: control-plane-postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: ${CONTROL_PLANE_DB_PASSWORD}
      DB_DATABASE: arc_saas
      KEYCLOAK_ENABLED: "true"
      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_REALM: ${KEYCLOAK_REALM:-ananta-saas}
      KEYCLOAK_ADMIN_USER: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      S3_ENDPOINT: http://control-plane-minio:9000
      AWS_ACCESS_KEY_ID: ${CONTROL_PLANE_MINIO_USER}
      AWS_SECRET_ACCESS_KEY: ${CONTROL_PLANE_MINIO_PASSWORD}
      NOVU_ENABLED: "true"
      NOVU_BACKEND_URL: http://novu-api:3000
      APP_PLANE_WEBHOOK_URL: http://webhook-bridge:27600
      APP_PLANE_WEBHOOK_SECRET: ${APP_PLANE_WEBHOOK_SECRET}
    restart: unless-stopped

  subscription-service:
    build:
      context: ../../arc-saas/services/subscription-service
      dockerfile: Dockerfile
    depends_on:
      control-plane-postgres:
        condition: service_healthy
      control-plane-redis:
        condition: service_healthy
    environment:
      NODE_ENV: production
      PORT: 3002
      DB_HOST: control-plane-postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: ${CONTROL_PLANE_DB_PASSWORD}
      DB_DATABASE: arc_saas
      DB_SCHEMA: subscription
      REDIS_HOST: control-plane-redis
      REDIS_PORT: 6379
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3002/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=3002
      - coolify.name=subscription-api

  # ===========================================================================
  # APP PLANE - DATABASES
  # ===========================================================================

  supabase-db:
    image: supabase/postgres:15.1.0.147
    volumes:
      - supabase-db-data:/var/lib/postgresql/data
      - ./migrations/001_SUPABASE_MASTER.sql:/docker-entrypoint-initdb.d/001_init.sql:ro
    environment:
      POSTGRES_PASSWORD: ${SUPABASE_DB_PASSWORD}
      POSTGRES_USER: postgres
      POSTGRES_DB: postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  components-v2-postgres:
    image: postgres:15-alpine
    volumes:
      - components-v2-postgres-data:/var/lib/postgresql/data
      - ./migrations/002_COMPONENTS_V2_MASTER.sql:/docker-entrypoint-initdb.d/001_init.sql:ro
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${COMPONENTS_V2_DB_PASSWORD}
      POSTGRES_DB: components_v2
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d components_v2"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ===========================================================================
  # APP PLANE - INFRASTRUCTURE
  # ===========================================================================

  app-plane-redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes --requirepass ${APP_PLANE_REDIS_PASSWORD:-}
    volumes:
      - app-plane-redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=15672
      - coolify.name=rabbitmq-mgmt

  app-plane-minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${APP_PLANE_MINIO_USER}
      MINIO_ROOT_PASSWORD: ${APP_PLANE_MINIO_PASSWORD}
    volumes:
      - app-plane-minio-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=9001
      - coolify.name=app-plane-minio

  app-plane-minio-init:
    image: minio/mc:latest
    depends_on:
      app-plane-minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://app-plane-minio:9000 $${APP_PLANE_MINIO_USER} $${APP_PLANE_MINIO_PASSWORD};
      mc mb myminio/bom-uploads --ignore-existing;
      mc mb myminio/documents --ignore-existing;
      mc mb myminio/exports --ignore-existing;
      mc mb myminio/avatars --ignore-existing;
      mc mb myminio/enrichment-audit --ignore-existing;
      mc mb myminio/bulk-uploads --ignore-existing;
      mc anonymous set download myminio/avatars;
      exit 0;
      "
    environment:
      APP_PLANE_MINIO_USER: ${APP_PLANE_MINIO_USER}
      APP_PLANE_MINIO_PASSWORD: ${APP_PLANE_MINIO_PASSWORD}

  # ===========================================================================
  # APP PLANE - SUPABASE
  # ===========================================================================

  supabase-api:
    image: postgrest/postgrest:v11.2.2
    environment:
      PGRST_DB_URI: postgres://postgres:${SUPABASE_DB_PASSWORD}@supabase-db:5432/postgres
      PGRST_DB_SCHEMA: public
      PGRST_DB_ANON_ROLE: anon
      PGRST_JWT_SECRET: ${SUPABASE_JWT_SECRET}
    depends_on:
      supabase-db:
        condition: service_healthy
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=3000
      - coolify.name=supabase-api

  supabase-meta:
    image: supabase/postgres-meta:v0.74.0
    environment:
      PG_META_PORT: 8080
      PG_META_DB_HOST: supabase-db
      PG_META_DB_PORT: 5432
      PG_META_DB_NAME: postgres
      PG_META_DB_USER: postgres
      PG_META_DB_PASSWORD: ${SUPABASE_DB_PASSWORD}
    depends_on:
      supabase-db:
        condition: service_healthy
    restart: unless-stopped

  supabase-studio:
    image: supabase/studio:latest
    environment:
      STUDIO_PG_META_URL: http://supabase-meta:8080
      POSTGRES_PASSWORD: ${SUPABASE_DB_PASSWORD}
      SUPABASE_URL: http://supabase-api:3000
    depends_on:
      - supabase-meta
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=3000
      - coolify.name=supabase-studio

  # ===========================================================================
  # APP PLANE - BACKEND SERVICES
  # ===========================================================================

  cns-service:
    build:
      context: ../services/cns-service
      dockerfile: Dockerfile
      target: production
    environment:
      NODE_ENV: production
      CNS_PORT: 8000
      CNS_HOST: 0.0.0.0
      LOG_LEVEL: INFO
      ENVIRONMENT: production
      DATABASE_URL: postgresql://postgres:${COMPONENTS_V2_DB_PASSWORD}@components-v2-postgres:5432/components_v2
      SUPABASE_DATABASE_URL: postgresql://postgres:${SUPABASE_DB_PASSWORD}@supabase-db:5432/postgres
      COMPONENTS_V2_DATABASE_URL: postgresql://postgres:${COMPONENTS_V2_DB_PASSWORD}@components-v2-postgres:5432/components_v2
      DATABASE_POOL_SIZE: 20
      REDIS_URL: redis://:${APP_PLANE_REDIS_PASSWORD:-}@app-plane-redis:6379/2
      JWT_SECRET_KEY: ${JWT_SECRET}
      AUTH0_ENABLED: "true"
      AUTH0_DOMAIN: ${KEYCLOAK_HOSTNAME}/realms/${KEYCLOAK_REALM}
      ADMIN_API_TOKEN: ${ADMIN_API_TOKEN}
      ALLOW_DEV_DEFAULTS: "false"
      TEMPORAL_ENABLED: "true"
      TEMPORAL_HOST: temporal:7233
      TEMPORAL_NAMESPACE: enrichment
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_PASS: ${RABBITMQ_PASSWORD}
      MOUSER_ENABLED: ${MOUSER_ENABLED:-true}
      MOUSER_API_KEY: ${MOUSER_API_KEY:-}
      DIGIKEY_ENABLED: ${DIGIKEY_ENABLED:-true}
      DIGIKEY_CLIENT_ID: ${DIGIKEY_CLIENT_ID:-}
      DIGIKEY_CLIENT_SECRET: ${DIGIKEY_CLIENT_SECRET:-}
      ELEMENT14_ENABLED: ${ELEMENT14_ENABLED:-true}
      ELEMENT14_API_KEY: ${ELEMENT14_API_KEY:-}
      MINIO_ENABLED: "true"
      MINIO_ENDPOINT: app-plane-minio:9000
      MINIO_ACCESS_KEY: ${APP_PLANE_MINIO_USER}
      MINIO_SECRET_KEY: ${APP_PLANE_MINIO_PASSWORD}
      MINIO_SECURE: "false"
      DEBUG: "false"
    depends_on:
      supabase-db:
        condition: service_healthy
      components-v2-postgres:
        condition: service_healthy
      app-plane-redis:
        condition: service_healthy
      app-plane-minio:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=8000
      - coolify.name=cns-api

  cns-worker:
    build:
      context: ../services/cns-service
      dockerfile: Dockerfile
      target: production
    command: python -m app.workers.bom_worker
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://postgres:${COMPONENTS_V2_DB_PASSWORD}@components-v2-postgres:5432/components_v2
      SUPABASE_DATABASE_URL: postgresql://postgres:${SUPABASE_DB_PASSWORD}@supabase-db:5432/postgres
      REDIS_URL: redis://:${APP_PLANE_REDIS_PASSWORD:-}@app-plane-redis:6379/2
      JWT_SECRET_KEY: ${JWT_SECRET}
      TEMPORAL_ENABLED: "true"
      TEMPORAL_HOST: temporal:7233
      TEMPORAL_NAMESPACE: enrichment
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_PASS: ${RABBITMQ_PASSWORD}
      MOUSER_API_KEY: ${MOUSER_API_KEY:-}
      DIGIKEY_CLIENT_ID: ${DIGIKEY_CLIENT_ID:-}
      DIGIKEY_CLIENT_SECRET: ${DIGIKEY_CLIENT_SECRET:-}
      MINIO_ENDPOINT: app-plane-minio:9000
      MINIO_ACCESS_KEY: ${APP_PLANE_MINIO_USER}
      MINIO_SECRET_KEY: ${APP_PLANE_MINIO_PASSWORD}
    depends_on:
      cns-service:
        condition: service_healthy
    restart: unless-stopped

  django-backend:
    build:
      context: ../services/backend
      dockerfile: Dockerfile
    environment:
      DEBUG: "False"
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY}
      ALLOWED_HOSTS: "*"
      DATABASE_URL: postgresql://postgres:${COMPONENTS_V2_DB_PASSWORD}@components-v2-postgres:5432/components_v2
      REDIS_URL: redis://:${APP_PLANE_REDIS_PASSWORD:-}@app-plane-redis:6379/0
    depends_on:
      components-v2-postgres:
        condition: service_healthy
      app-plane-redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=8000
      - coolify.name=django-api

  # ===========================================================================
  # APP PLANE - MIDDLEWARE & INTEGRATION SERVICES
  # ===========================================================================

  middleware-api:
    build:
      context: ../services/middleware-api
      dockerfile: Dockerfile
    environment:
      FLASK_ENV: production
      DATABASE_URL: postgres://postgres:${SUPABASE_DB_PASSWORD}@supabase-db:5432/postgres
      REDIS_URL: redis://:${APP_PLANE_REDIS_PASSWORD:-}@app-plane-redis:6379/3
      DJANGO_API_URL: http://django-backend:8000
      CNS_API_URL: http://cns-service:8000
      CONTROL_PLANE_URL: http://tenant-management-service:14000
    depends_on:
      django-backend:
        condition: service_healthy
      cns-service:
        condition: service_healthy
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=5000
      - coolify.name=middleware-api

  webhook-bridge:
    build:
      context: ../webhook-bridge
      dockerfile: Dockerfile
    environment:
      WEBHOOK_SECRET: ${APP_PLANE_WEBHOOK_SECRET}
      SUPABASE_URL: http://supabase-api:3000
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      FLASK_ENV: production
    depends_on:
      supabase-db:
        condition: service_healthy
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=27600
      - coolify.name=webhook-bridge

  # ===========================================================================
  # APP PLANE - BACKGROUND WORKERS
  # ===========================================================================

  audit-logger:
    build:
      context: ..
      dockerfile: services/audit-logger/Dockerfile
    environment:
      DATABASE_URL: postgres://postgres:${SUPABASE_DB_PASSWORD}@supabase-db:5432/postgres
      SUPABASE_DB_HOST: supabase-db
      SUPABASE_DB_PORT: 5432
      SUPABASE_DB_NAME: postgres
      SUPABASE_DB_USER: postgres
      SUPABASE_DB_PASSWORD: ${SUPABASE_DB_PASSWORD}
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_PASS: ${RABBITMQ_PASSWORD}
      LOG_LEVEL: INFO
      TEMPORAL_ENABLED: "true"
      TEMPORAL_HOST: temporal:7233
      TEMPORAL_NAMESPACE: enrichment
      TEMPORAL_TASK_QUEUE: cns-enrichment
    depends_on:
      supabase-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  novu-consumer:
    build:
      context: ../services/novu-consumer
      dockerfile: Dockerfile
    environment:
      NOVU_API_KEY: ${NOVU_API_KEY}
      NOVU_URL: http://novu-api:3000
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_STREAM_PORT: 5552
      RABBITMQ_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
    depends_on:
      rabbitmq:
        condition: service_healthy
      novu-api:
        condition: service_started
    restart: unless-stopped

  # ===========================================================================
  # APP PLANE - CONTENT MANAGEMENT
  # ===========================================================================

  directus:
    image: directus/directus:latest
    environment:
      KEY: ${DIRECTUS_KEY:-directus-key-change-in-production}
      SECRET: ${DIRECTUS_SECRET:-directus-secret-change-in-production}
      DB_CLIENT: pg
      DB_HOST: supabase-db
      DB_PORT: 5432
      DB_DATABASE: directus
      DB_USER: postgres
      DB_PASSWORD: ${SUPABASE_DB_PASSWORD}
      ADMIN_EMAIL: ${DIRECTUS_ADMIN_EMAIL:-admin@example.com}
      ADMIN_PASSWORD: ${DIRECTUS_ADMIN_PASSWORD}
      PUBLIC_URL: ${DIRECTUS_PUBLIC_URL}
      CORS_ENABLED: "true"
      CORS_ORIGIN: "*"
      CACHE_ENABLED: "true"
      CACHE_STORE: redis
      REDIS: redis://:${APP_PLANE_REDIS_PASSWORD:-}@app-plane-redis:6379/4
    volumes:
      - directus-uploads:/directus/uploads
    depends_on:
      supabase-db:
        condition: service_healthy
      app-plane-redis:
        condition: service_healthy
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=8055
      - coolify.name=directus-cms

  # ===========================================================================
  # FRONTENDS
  # ===========================================================================

  admin-app:
    build:
      context: ../../arc-saas/apps/admin-app
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${CONTROL_PLANE_API_URL}
        VITE_KEYCLOAK_URL: ${KEYCLOAK_URL}
        VITE_KEYCLOAK_REALM: ${KEYCLOAK_REALM:-ananta-saas}
        VITE_KEYCLOAK_CLIENT_ID: admin-portal
    depends_on:
      - tenant-management-service
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=80
      - coolify.name=admin-portal

  customer-portal:
    build:
      context: ../../arc-saas/apps/customer-portal
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${CONTROL_PLANE_API_URL}
        VITE_KEYCLOAK_URL: ${KEYCLOAK_URL}
        VITE_KEYCLOAK_REALM: ${KEYCLOAK_REALM:-ananta-saas}
        VITE_KEYCLOAK_CLIENT_ID: cbp-frontend
        VITE_CNS_API_URL: ${CNS_API_URL}
    depends_on:
      - tenant-management-service
      - cns-service
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=80
      - coolify.name=customer-portal

  cns-dashboard:
    build:
      context: ../services/cns-service/dashboard
      dockerfile: Dockerfile
      args:
        VITE_CNS_API_URL: ${CNS_API_URL}
        VITE_KEYCLOAK_URL: ${KEYCLOAK_URL}
        VITE_KEYCLOAK_REALM: ${KEYCLOAK_REALM:-ananta-saas}
        VITE_KEYCLOAK_CLIENT_ID: cns-dashboard
    depends_on:
      cns-service:
        condition: service_healthy
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=80
      - coolify.name=cns-dashboard

  backstage-portal:
    build:
      context: ../services/backstage-portal
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${CNS_API_URL}
        VITE_KEYCLOAK_URL: ${KEYCLOAK_URL}
        VITE_KEYCLOAK_REALM: ${KEYCLOAK_REALM:-ananta-saas}
        VITE_KEYCLOAK_CLIENT_ID: backstage-portal
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=80
      - coolify.name=backstage-portal

  dashboard:
    build:
      context: ../services/dashboard
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${DJANGO_API_URL:-http://django-backend:8000}
        NEXT_PUBLIC_SUPABASE_URL: ${SUPABASE_API_URL}
        NEXT_PUBLIC_KEYCLOAK_URL: ${KEYCLOAK_URL}
        NEXT_PUBLIC_KEYCLOAK_REALM: ${KEYCLOAK_REALM:-ananta-saas}
        NEXT_PUBLIC_KEYCLOAK_CLIENT_ID: dashboard
    depends_on:
      django-backend:
        condition: service_healthy
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=3000
      - coolify.name=unified-dashboard

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  # Control Plane
  control-plane-postgres-data:
  control-plane-redis-data:
  control-plane-minio-data:
  temporal-postgres-data:
  novu-mongo-data:
  novu-redis-data:
  # App Plane
  supabase-db-data:
  components-v2-postgres-data:
  app-plane-redis-data:
  app-plane-minio-data:
  rabbitmq-data:
  directus-uploads:

# =============================================================================
# NETWORKS
# =============================================================================
# Single network for Coolify - all services communicate on same network
# For on-premise deployments needing isolation, split into:
#   - control-plane-network (arc-saas services)
#   - app-plane-network (CNS, Django, Supabase)
#   - shared-services-network (Temporal, monitoring)
networks:
  default:
    name: ananta-platform-coolify
    driver: bridge
