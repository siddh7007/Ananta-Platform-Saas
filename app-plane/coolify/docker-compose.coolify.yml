# =============================================================================
# Coolify Production Deployment - App Plane
# =============================================================================
#
# This docker-compose is optimized for Coolify deployment.
# Coolify will handle:
#   - SSL/TLS certificates (Let's Encrypt)
#   - Reverse proxy (Traefik)
#   - Environment variable injection
#   - Health monitoring
#   - Automatic restarts
#
# Deployment:
#   1. Create a new project in Coolify
#   2. Add this as a Docker Compose resource
#   3. Configure environment variables in Coolify UI
#   4. Deploy
#
# =============================================================================

services:
  # ===========================================================================
  # DATABASES
  # ===========================================================================

  supabase-db:
    image: supabase/postgres:15.1.0.147
    volumes:
      - supabase-db-data:/var/lib/postgresql/data
      - ./supabase/init:/docker-entrypoint-initdb.d
    environment:
      POSTGRES_PASSWORD: ${SUPABASE_DB_PASSWORD}
      POSTGRES_USER: postgres
      POSTGRES_DB: postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    labels:
      - coolify.managed=true

  components-v2-postgres:
    image: postgres:15-alpine
    volumes:
      - components-v2-postgres-data:/var/lib/postgresql/data
      - ./database/components-v2-init:/docker-entrypoint-initdb.d
    environment:
      POSTGRES_USER: ${COMPONENTS_V2_DB_USER:-postgres}
      POSTGRES_PASSWORD: ${COMPONENTS_V2_DB_PASSWORD}
      POSTGRES_DB: ${COMPONENTS_V2_DB_NAME:-components_v2}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d components_v2"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    labels:
      - coolify.managed=true

  # ===========================================================================
  # INFRASTRUCTURE
  # ===========================================================================

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-}
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    labels:
      - coolify.managed=true

  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
      RABBITMQ_DEFAULT_VHOST: /
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=15672
      - coolify.name=rabbitmq-management

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=9001
      - coolify.name=minio-console

  minio-init:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 $${MINIO_ROOT_USER} $${MINIO_ROOT_PASSWORD};
      mc mb myminio/bom-uploads --ignore-existing;
      mc mb myminio/documents --ignore-existing;
      mc mb myminio/exports --ignore-existing;
      mc mb myminio/avatars --ignore-existing;
      mc mb myminio/enrichment-audit --ignore-existing;
      mc mb myminio/bulk-uploads --ignore-existing;
      mc anonymous set download myminio/avatars;
      echo 'MinIO buckets initialized';
      exit 0;
      "
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}

  # ===========================================================================
  # SUPABASE SERVICES
  # ===========================================================================

  supabase-api:
    image: postgrest/postgrest:v11.2.2
    environment:
      PGRST_DB_URI: postgres://postgres:${SUPABASE_DB_PASSWORD}@supabase-db:5432/postgres
      PGRST_DB_SCHEMA: public
      PGRST_DB_ANON_ROLE: anon
      PGRST_JWT_SECRET: ${SUPABASE_JWT_SECRET}
      PGRST_DB_EXTRA_SEARCH_PATH: public,extensions
    depends_on:
      supabase-db:
        condition: service_healthy
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=3000
      - coolify.name=supabase-api

  supabase-meta:
    image: supabase/postgres-meta:v0.74.0
    environment:
      PG_META_PORT: 8080
      PG_META_DB_HOST: supabase-db
      PG_META_DB_PORT: 5432
      PG_META_DB_NAME: postgres
      PG_META_DB_USER: postgres
      PG_META_DB_PASSWORD: ${SUPABASE_DB_PASSWORD}
    depends_on:
      supabase-db:
        condition: service_healthy
    restart: unless-stopped

  supabase-studio:
    image: supabase/studio:latest
    environment:
      STUDIO_PG_META_URL: http://supabase-meta:8080
      POSTGRES_PASSWORD: ${SUPABASE_DB_PASSWORD}
      SUPABASE_URL: http://supabase-api:3000
      SUPABASE_REST_URL: http://supabase-api:3000/rest/v1/
    depends_on:
      - supabase-db
      - supabase-meta
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=3000
      - coolify.name=supabase-studio

  # ===========================================================================
  # BACKEND SERVICES
  # ===========================================================================

  cns-service:
    build:
      context: ./services/cns-service
      dockerfile: Dockerfile
      target: production
    environment:
      NODE_ENV: production
      CNS_PORT: 8000
      CNS_HOST: 0.0.0.0
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      ENVIRONMENT: production
      # Database
      DATABASE_URL: postgresql://postgres:${COMPONENTS_V2_DB_PASSWORD}@components-v2-postgres:5432/components_v2
      SUPABASE_DATABASE_URL: postgresql://postgres:${SUPABASE_DB_PASSWORD}@supabase-db:5432/postgres
      COMPONENTS_V2_DATABASE_URL: postgresql://postgres:${COMPONENTS_V2_DB_PASSWORD}@components-v2-postgres:5432/components_v2
      DATABASE_POOL_SIZE: 20
      DATABASE_MAX_OVERFLOW: 10
      # Redis
      REDIS_URL: redis://:${REDIS_PASSWORD:-}@redis:6379/2
      REDIS_CACHE_TTL: 3600
      # Auth
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_ALGORITHM: HS256
      JWT_EXPIRATION: 3600
      AUTH0_ENABLED: ${AUTH0_ENABLED:-true}
      AUTH0_DOMAIN: ${AUTH0_DOMAIN}
      AUTH0_AUDIENCE: ${AUTH0_AUDIENCE:-cbp-frontend,cns-api,account}
      # Admin Token
      ADMIN_API_TOKEN: ${ADMIN_API_TOKEN}
      CNS_ADMIN_API_TOKEN: ${ADMIN_API_TOKEN}
      ALLOW_DEV_DEFAULTS: "false"
      # Temporal
      TEMPORAL_ENABLED: ${TEMPORAL_ENABLED:-true}
      TEMPORAL_HOST: ${TEMPORAL_HOST:-temporal:7233}
      TEMPORAL_NAMESPACE: ${TEMPORAL_NAMESPACE:-enrichment}
      TEMPORAL_TASK_QUEUE: ${TEMPORAL_TASK_QUEUE:-cns-enrichment}
      # RabbitMQ
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_PASS: ${RABBITMQ_PASSWORD}
      RABBITMQ_VHOST: /
      # AI Providers
      OLLAMA_ENABLED: ${OLLAMA_ENABLED:-false}
      OPENAI_ENABLED: ${OPENAI_ENABLED:-false}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      CLAUDE_ENABLED: ${CLAUDE_ENABLED:-false}
      CLAUDE_API_KEY: ${CLAUDE_API_KEY:-}
      # Supplier APIs
      MOUSER_ENABLED: ${MOUSER_ENABLED:-true}
      MOUSER_API_KEY: ${MOUSER_API_KEY:-}
      DIGIKEY_ENABLED: ${DIGIKEY_ENABLED:-true}
      DIGIKEY_CLIENT_ID: ${DIGIKEY_CLIENT_ID:-}
      DIGIKEY_CLIENT_SECRET: ${DIGIKEY_CLIENT_SECRET:-}
      ELEMENT14_ENABLED: ${ELEMENT14_ENABLED:-true}
      ELEMENT14_API_KEY: ${ELEMENT14_API_KEY:-}
      # MinIO
      MINIO_ENABLED: "true"
      MINIO_ENDPOINT: minio:9000
      MINIO_PUBLIC_ENDPOINT: ${MINIO_PUBLIC_URL:-minio.yourdomain.com}
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD}
      MINIO_SECURE: "false"
      S3_BUCKET_NAME: bom-uploads
      # Quality Thresholds
      QUALITY_REJECT_THRESHOLD: ${QUALITY_REJECT_THRESHOLD:-70}
      QUALITY_STAGING_THRESHOLD: ${QUALITY_STAGING_THRESHOLD:-94}
      QUALITY_AUTO_APPROVE_THRESHOLD: ${QUALITY_AUTO_APPROVE_THRESHOLD:-95}
      # Production Settings
      DEBUG: "false"
      TEST_MODE: "false"
    depends_on:
      supabase-db:
        condition: service_healthy
      components-v2-postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=8000
      - coolify.name=cns-api

  cns-worker:
    build:
      context: ./services/cns-service
      dockerfile: Dockerfile
      target: production
    command: python -m app.workers.bom_worker
    environment:
      NODE_ENV: production
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      ENVIRONMENT: production
      DATABASE_URL: postgresql://postgres:${COMPONENTS_V2_DB_PASSWORD}@components-v2-postgres:5432/components_v2
      SUPABASE_DATABASE_URL: postgresql://postgres:${SUPABASE_DB_PASSWORD}@supabase-db:5432/postgres
      COMPONENTS_V2_DATABASE_URL: postgresql://postgres:${COMPONENTS_V2_DB_PASSWORD}@components-v2-postgres:5432/components_v2
      DATABASE_POOL_SIZE: 10
      DATABASE_MAX_OVERFLOW: 5
      REDIS_URL: redis://:${REDIS_PASSWORD:-}@redis:6379/2
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      TEMPORAL_ENABLED: ${TEMPORAL_ENABLED:-true}
      TEMPORAL_HOST: ${TEMPORAL_HOST:-temporal:7233}
      TEMPORAL_NAMESPACE: ${TEMPORAL_NAMESPACE:-enrichment}
      TEMPORAL_TASK_QUEUE: ${TEMPORAL_TASK_QUEUE:-cns-enrichment}
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_PASS: ${RABBITMQ_PASSWORD}
      # Supplier APIs
      MOUSER_ENABLED: ${MOUSER_ENABLED:-true}
      MOUSER_API_KEY: ${MOUSER_API_KEY:-}
      DIGIKEY_ENABLED: ${DIGIKEY_ENABLED:-true}
      DIGIKEY_CLIENT_ID: ${DIGIKEY_CLIENT_ID:-}
      DIGIKEY_CLIENT_SECRET: ${DIGIKEY_CLIENT_SECRET:-}
      ELEMENT14_ENABLED: ${ELEMENT14_ENABLED:-true}
      ELEMENT14_API_KEY: ${ELEMENT14_API_KEY:-}
      # MinIO
      MINIO_ENABLED: "true"
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD}
      MINIO_SECURE: "false"
    depends_on:
      cns-service:
        condition: service_healthy
    restart: unless-stopped
    labels:
      - coolify.managed=true

  # ===========================================================================
  # FRONTEND SERVICES
  # ===========================================================================

  cns-dashboard:
    build:
      context: ./services/cns-service/dashboard
      dockerfile: Dockerfile
      args:
        VITE_CNS_API_URL: ${CNS_API_URL:-/api}
        VITE_KEYCLOAK_URL: ${KEYCLOAK_URL}
        VITE_KEYCLOAK_REALM: ${KEYCLOAK_REALM:-ananta-saas}
        VITE_KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID:-cns-dashboard}
    depends_on:
      cns-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=80
      - coolify.name=cns-dashboard

  customer-portal:
    build:
      context: ./services/customer-portal
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${API_URL:-/api}
        VITE_KEYCLOAK_URL: ${KEYCLOAK_URL}
        VITE_KEYCLOAK_REALM: ${KEYCLOAK_REALM:-ananta-saas}
        VITE_KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID:-customer-portal}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=80
      - coolify.name=customer-portal

  backstage-portal:
    build:
      context: ./services/backstage-portal
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${API_URL:-/api}
        VITE_KEYCLOAK_URL: ${KEYCLOAK_URL}
        VITE_KEYCLOAK_REALM: ${KEYCLOAK_REALM:-ananta-saas}
        VITE_KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID:-backstage-portal}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=80
      - coolify.name=backstage-portal

  # ===========================================================================
  # DJANGO BACKEND (Component Catalog)
  # ===========================================================================

  django-backend:
    build:
      context: ./services/backend
      dockerfile: Dockerfile
    environment:
      DEBUG: "False"
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS:-*}
      DATABASE_URL: postgresql://postgres:${COMPONENTS_V2_DB_PASSWORD}@components-v2-postgres:5432/components_v2
      REDIS_URL: redis://:${REDIS_PASSWORD:-}@redis:6379/0
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-*}
    depends_on:
      components-v2-postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    labels:
      - coolify.managed=true
      - coolify.port=8000
      - coolify.name=django-api

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  supabase-db-data:
  components-v2-postgres-data:
  redis-data:
  rabbitmq-data:
  minio-data:

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  default:
    name: app-plane-coolify
