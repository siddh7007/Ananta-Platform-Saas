version: '3.8'

# ==========================================
# Component Normalization Service (CNS) Service
# Docker Compose Configuration
# ==========================================

services:
  # ==========================================
  # CNS FastAPI Service
  # ==========================================
  cns-service:
    build:
      context: .
      dockerfile: Dockerfile
      target: application  # Use 'development' for dev mode
    container_name: components-v2-cns-service
    hostname: cns-service
    ports:
      - "${CNS_PORT:-27800}:27800"
      - "${METRICS_PORT:-27801}:27801"  # Prometheus metrics
    labels:
      - "traefik.enable=true"
      # CNS API at /cns-api
      - "traefik.http.routers.cns-api.rule=Host(`localhost`) && PathPrefix(`/cns-api`)"
      - "traefik.http.routers.cns-api.entrypoints=web"
      - "traefik.http.routers.cns-api.priority=100"
      - "traefik.http.routers.cns-api.middlewares=strip-cns-api@file,cors-headers@file,security-headers@file,compress@file"
      - "traefik.http.services.cns-api.loadbalancer.server.port=27800"
    environment:
      # Service Configuration
      CNS_PORT: 27800
      CNS_HOST: 0.0.0.0
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      ENVIRONMENT: ${ENVIRONMENT:-development}

      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-components}
      DATABASE_POOL_SIZE: 20
      DATABASE_MAX_OVERFLOW: 10

      # Redis
      REDIS_URL: redis://redis:6379/0
      REDIS_CACHE_TTL: 3600

      # Temporal
      TEMPORAL_URL: temporal:7233
      TEMPORAL_NAMESPACE: default
      TEMPORAL_TASK_QUEUE: cip-enrichment

      # AI Providers
      OLLAMA_ENABLED: ${OLLAMA_ENABLED:-true}
      OLLAMA_URL: http://ollama:27260
      OLLAMA_MODEL: ${OLLAMA_MODEL:-llama3:8b}

      OPENAI_ENABLED: ${OPENAI_ENABLED:-false}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4-turbo}

      CLAUDE_ENABLED: ${CLAUDE_ENABLED:-false}
      CLAUDE_API_KEY: ${CLAUDE_API_KEY:-}
      CLAUDE_MODEL: ${CLAUDE_MODEL:-claude-3-sonnet-20240229}

      PERPLEXITY_ENABLED: ${PERPLEXITY_ENABLED:-false}
      PERPLEXITY_API_KEY: ${PERPLEXITY_API_KEY:-}

      # Supplier APIs
      MOUSER_ENABLED: ${MOUSER_ENABLED:-true}
      MOUSER_API_KEY: ${MOUSER_API_KEY:-}

      DIGIKEY_ENABLED: ${DIGIKEY_ENABLED:-true}
      DIGIKEY_CLIENT_ID: ${DIGIKEY_CLIENT_ID:-}
      DIGIKEY_CLIENT_SECRET: ${DIGIKEY_CLIENT_SECRET:-}

      ELEMENT14_ENABLED: ${ELEMENT14_ENABLED:-true}
      ELEMENT14_API_KEY: ${ELEMENT14_API_KEY:-}

      # Quality Thresholds
      QUALITY_REJECT_THRESHOLD: ${QUALITY_REJECT_THRESHOLD:-70}
      QUALITY_STAGING_THRESHOLD: ${QUALITY_STAGING_THRESHOLD:-94}
      QUALITY_AUTO_APPROVE_THRESHOLD: ${QUALITY_AUTO_APPROVE_THRESHOLD:-95}

      # Authentication
      KEYCLOAK_URL: http://keycloak:27100/realms/components-platform
      KEYCLOAK_CLIENT_ID: cns-service
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET:-}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-change-this-in-production}
      JWT_ALGORITHM: HS256
      JWT_EXPIRATION: 3600

      # CORS
      # CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:27500,http://localhost:3000,http://localhost:27810}  # DISABLED: Using defaults in config.py
      # CORS_ALLOW_CREDENTIALS: ${CORS_ALLOW_CREDENTIALS:-true}  # DISABLED: Using defaults in config.py

      # File Upload
      MAX_UPLOAD_SIZE: 10485760  # 10 MB
      # ALLOWED_FILE_EXTENSIONS: .csv,.xlsx,.xls  # DISABLED: Using defaults in config.py (Pydantic parsing issue)
      UPLOAD_DIR: /app/uploads

      # Monitoring
      GRAFANA_URL: http://grafana:3000
      LOKI_URL: http://loki:3100
      PROMETHEUS_URL: http://prometheus:9090
      ENABLE_METRICS: "true"
      METRICS_PORT: 27701

      # Feature Flags
      ENABLE_AI_SUGGESTIONS: ${ENABLE_AI_SUGGESTIONS:-true}
      ENABLE_WEB_SCRAPING: ${ENABLE_WEB_SCRAPING:-false}
      ENABLE_TIER2_SUPPLIERS: ${ENABLE_TIER2_SUPPLIERS:-false}
      ENABLE_TIER3_OEM: ${ENABLE_TIER3_OEM:-false}
      ENABLE_MULTI_AI_FALLBACK: ${ENABLE_MULTI_AI_FALLBACK:-true}
      ENABLE_COST_TRACKING: ${ENABLE_COST_TRACKING:-true}

      # Development
      DEBUG: ${DEBUG:-false}
      TEST_MODE: ${TEST_MODE:-false}
      MOCK_SUPPLIER_APIS: ${MOCK_SUPPLIER_APIS:-false}

      # Category Snapshot Auto-Refresh (in-container via Temporal hook)
      CATEGORY_SNAPSHOT_AUTO_REFRESH: ${CATEGORY_SNAPSHOT_AUTO_REFRESH:-1}
      CATEGORY_SNAPSHOT_CHECK_INTERVAL_MINUTES: ${CATEGORY_SNAPSHOT_CHECK_INTERVAL_MINUTES:-30}
      CATEGORY_SNAPSHOT_MAX_STALENESS_MINUTES: ${CATEGORY_SNAPSHOT_MAX_STALENESS_MINUTES:-1440}
      CATEGORY_SNAPSHOT_GENERATE_GAP_REPORT: ${CATEGORY_SNAPSHOT_GENERATE_GAP_REPORT:-1}
      CATEGORY_GAP_REPORT_OUTPUT: ${CATEGORY_GAP_REPORT_OUTPUT:-docs/data-processing/normalizer_mapping_gap_report.csv}
      CATEGORY_GAP_REPORT_NOTIFY: ${CATEGORY_GAP_REPORT_NOTIFY:-1}
      CATEGORY_GAP_REPORT_SAMPLE_ROWS: ${CATEGORY_GAP_REPORT_SAMPLE_ROWS:-5}

    volumes:
      # Mount uploads directory
      - cip-uploads:/app/uploads

      # For development: Mount source code for hot reload
      # Uncomment for development mode:
      # - ./app:/app/app:ro

    # depends_on:
    #   - postgres
    #   - redis
    # Dependencies are in separate compose file, services accessed via external network

    networks:
      - components-network

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:27800/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================
  # CNS Dashboard (React Admin)
  # ==========================================
  cns-dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    container_name: cns-dashboard
    hostname: cns-dashboard
    ports:
      - "27810:27810"
    depends_on:
      - cns-service
    networks:
      - components-network
    restart: unless-stopped
    labels:
      - "com.components-platform.service=cns-dashboard"
      - "com.components-platform.description=CNS Analytics Dashboard"
      - "traefik.enable=true"
      # CNS Dashboard at /cns
      - "traefik.http.routers.cns-dashboard.rule=Host(`localhost`) && PathPrefix(`/cns`)"
      - "traefik.http.routers.cns-dashboard.entrypoints=web"
      - "traefik.http.routers.cns-dashboard.priority=250"
      - "traefik.http.routers.cns-dashboard.middlewares=strip-cns-dashboard@file,security-headers@file,compress@file"
      - "traefik.http.services.cns-dashboard.loadbalancer.server.port=27810"
      - "traefik.docker.network=components-v2-network"

  # ==========================================
  # CNS Temporal Worker (Optional - can run separately)
  # ==========================================
  cip-worker:
    build:
      context: .
      dockerfile: Dockerfile
      target: application
    container_name: cip-worker
    hostname: cip-worker
    command: ["python", "app/workflows/worker.py"]  # Will be created later
    environment:
      # Same environment as cns-service
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-components}
      REDIS_URL: redis://redis:6379/0
      TEMPORAL_URL: temporal:7233
      TEMPORAL_NAMESPACE: default
      TEMPORAL_TASK_QUEUE: cip-enrichment
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      CATEGORY_SNAPSHOT_AUTO_REFRESH: ${CATEGORY_SNAPSHOT_AUTO_REFRESH:-1}
      CATEGORY_SNAPSHOT_CHECK_INTERVAL_MINUTES: ${CATEGORY_SNAPSHOT_CHECK_INTERVAL_MINUTES:-30}
      CATEGORY_SNAPSHOT_MAX_STALENESS_MINUTES: ${CATEGORY_SNAPSHOT_MAX_STALENESS_MINUTES:-1440}
      CATEGORY_SNAPSHOT_GENERATE_GAP_REPORT: ${CATEGORY_SNAPSHOT_GENERATE_GAP_REPORT:-1}
      CATEGORY_GAP_REPORT_OUTPUT: ${CATEGORY_GAP_REPORT_OUTPUT:-docs/data-processing/normalizer_mapping_gap_report.csv}
      CATEGORY_GAP_REPORT_NOTIFY: ${CATEGORY_GAP_REPORT_NOTIFY:-1}
      CATEGORY_GAP_REPORT_SAMPLE_ROWS: ${CATEGORY_GAP_REPORT_SAMPLE_ROWS:-5}

      # AI and Supplier configurations (same as cns-service)
      OLLAMA_ENABLED: ${OLLAMA_ENABLED:-true}
      OLLAMA_URL: http://ollama:27260
      MOUSER_API_KEY: ${MOUSER_API_KEY:-}
      DIGIKEY_CLIENT_ID: ${DIGIKEY_CLIENT_ID:-}
      ELEMENT14_API_KEY: ${ELEMENT14_API_KEY:-}

    depends_on:
      - postgres
      - redis
      - temporal

    networks:
      - components-network

    restart: unless-stopped

    labels:
      com.components-platform.service: "cip-worker"
      com.components-platform.description: "CNS Temporal Worker"

    # Comment out until worker.py is implemented
    profiles:
      - full  # Only start with --profile full

# ==========================================
# Volumes
# ==========================================
volumes:
  cip-uploads:
    name: cip-uploads
    driver: local

# ==========================================
# Networks
# ==========================================
networks:
  components-network:
    name: components-v2-network
    external: true  # Assumes main network already exists
