# Verification Email Fix Guide

## Problem
Lead registration shows "Check Your Email!" message, but no verification email is sent.

## Root Causes
1. Novu workflow template missing for `validate-lead`
2. No email provider (SMTP) configured in Novu
3. Novu integration errors: `TypeError: Cannot read properties of undefined (reading '_zod')`

## Solution

### Step 1: Configure Novu Email Provider

1. **Access Novu Web UI:**
   ```
   http://localhost:14200
   ```

2. **Login to Novu:**
   - Default credentials (check `.env` file for `NOVU_API_KEY`)

3. **Add Email Provider:**
   - Navigate to **Integration Store** → **Email**
   - Choose a provider:
     - **SendGrid** (recommended for production)
     - **Gmail** (for testing)
     - **AWS SES** (for production)
     - **Custom SMTP** (for any SMTP server)

4. **Example: Gmail SMTP Setup**
   ```
   Provider: SMTP
   From Name: Ananta Platform
   From Email: your-email@gmail.com
   SMTP Host: smtp.gmail.com
   SMTP Port: 587
   Username: your-email@gmail.com
   Password: [App Password - not regular password]
   ```

   **Note:** For Gmail, enable "2-Step Verification" and generate an "App Password":
   https://myaccount.google.com/apppasswords

5. **Test Connection:**
   - Click "Test" button to send a test email
   - Verify email arrives in inbox

---

### Step 2: Create Novu Workflow Template

1. **Navigate to Workflows:**
   ```
   Novu UI → Workflows → Create Workflow
   ```

2. **Create "Lead Validation" Workflow:**
   - **Workflow Name:** `validate-lead`
   - **Workflow Identifier:** `validate-lead` (must match code)
   - **Channel:** Email

3. **Configure Email Template:**

   **Subject:**
   ```
   Verify Your Email - {{companyName}}
   ```

   **Email Body (HTML):**
   ```html
   <!DOCTYPE html>
   <html>
   <head>
       <style>
           body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
           .container { max-width: 600px; margin: 0 auto; padding: 20px; }
           .header { background: #2563eb; color: white; padding: 20px; text-align: center; }
           .content { padding: 30px; background: #f9fafb; }
           .button { display: inline-block; background: #2563eb; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; }
           .footer { text-align: center; padding: 20px; color: #6b7280; font-size: 12px; }
       </style>
   </head>
   <body>
       <div class="container">
           <div class="header">
               <h1>Welcome to Ananta Platform!</h1>
           </div>
           <div class="content">
               <p>Hi {{firstName}},</p>
               <p>Thank you for registering <strong>{{companyName}}</strong>!</p>
               <p>Please verify your email address by clicking the button below:</p>
               <p style="text-align: center; margin: 30px 0;">
                   <a href="{{validationUrl}}" class="button">Verify Email Address</a>
               </p>
               <p style="color: #6b7280; font-size: 14px;">
                   Or copy this link into your browser:<br>
                   <code>{{validationUrl}}</code>
               </p>
               <p style="color: #6b7280; font-size: 14px;">
                   This link will expire in 24 hours.
               </p>
           </div>
           <div class="footer">
               <p>&copy; 2024 Ananta Platform. All rights reserved.</p>
           </div>
       </div>
   </body>
   </html>
   ```

4. **Configure Variables:**
   - `firstName` - Lead's first name
   - `companyName` - Company name
   - `validationUrl` - Verification link (auto-generated by backend)
   - `email` - Lead's email address

5. **Save Workflow**

---

### Step 3: Update Environment Variables

Ensure these are set in `arc-saas/services/tenant-management-service/.env`:

```bash
# Novu Configuration
NOVU_API_KEY=your-novu-api-key-from-dashboard
NOVU_APP_IDENTIFIER=your-novu-app-id

# Frontend URL for verification links
CUSTOMER_PORTAL_URL=http://localhost:27100

# Lead Token Settings
LEAD_KEY_LENGTH=32
VALIDATION_TOKEN_EXPIRY=86400  # 24 hours in seconds

# JWT Settings
JWT_SECRET=your-secret-key
JWT_ISSUER=arc-saas-platform
```

**Get Novu API Key:**
1. Novu UI → Settings → API Keys
2. Copy "API Key" (starts with `novu_`)

---

### Step 4: Restart Services

```bash
# Restart tenant-management-service to reload environment
docker restart arc-saas-tenant-mgmt

# Restart temporal worker to pick up new Novu config
docker restart arc-saas-temporal-worker
```

---

### Step 5: Test End-to-End

1. **Clear Redis cache:**
   ```bash
   docker exec arc-saas-redis redis-cli FLUSHALL
   ```

2. **Register a new lead:**
   - Go to: http://localhost:27555/register
   - Fill in the form with a **real email address you can access**
   - Click "Start Your Journey"

3. **Check for success:**
   - Frontend shows: "Check Your Email!"
   - Email arrives in inbox within 1-2 minutes

4. **Verify email workflow:**
   - Click verification link in email
   - Should redirect to: `http://localhost:27555/register/verify?token=xxx`
   - Frontend shows: "Email Verified!"
   - Click "Continue to Setup"

5. **Check logs:**
   ```bash
   # Check if email was sent
   docker logs arc-saas-tenant-mgmt --tail 50 | grep "Validation email sent"

   # Check Novu logs
   docker logs arc-saas-novu-api --tail 50 | grep -i "email\|sent"
   ```

---

## Verification Checklist

- [ ] Novu email provider configured and tested
- [ ] `validate-lead` workflow created in Novu
- [ ] Email template includes all required variables
- [ ] `NOVU_API_KEY` set in `.env`
- [ ] `CUSTOMER_PORTAL_URL` points to correct frontend
- [ ] Services restarted
- [ ] Test email sent and received
- [ ] Verification link works
- [ ] Lead marked as `is_validated=true` in database

---

## Troubleshooting

### Email Not Received

1. **Check Novu dashboard:**
   - Novu UI → Activity Feed
   - Look for `validate-lead` workflow execution
   - Check for errors

2. **Check service logs:**
   ```bash
   # Tenant management service
   docker logs arc-saas-tenant-mgmt --tail 100 | grep -i "email\|novu"

   # Novu API logs
   docker logs arc-saas-novu-api --tail 100
   ```

3. **Verify lead was created:**
   ```bash
   docker exec -e PGPASSWORD=postgres arc-saas-postgres psql -U postgres -d arc_saas -c \
     "SELECT email, is_validated, created_on FROM main.leads ORDER BY created_on DESC LIMIT 5;"
   ```

4. **Check Redis token storage:**
   ```bash
   docker exec arc-saas-redis redis-cli KEYS "lead-token:*"
   ```

### Verification Link Expired

- Tokens expire after 24 hours (`VALIDATION_TOKEN_EXPIRY=86400`)
- User must re-register if expired
- TODO: Add "Resend Verification Email" button

### Novu Integration Errors

```
Failed to send via Novu: Input validation failed: TypeError: Cannot read properties of undefined (reading '_zod')
```

**Solution:**
- Update `@novu/node` package:
  ```bash
  cd arc-saas/services/tenant-management-service
  bun add @novu/node@latest
  docker restart arc-saas-tenant-mgmt
  ```

- Check workflow identifier matches exactly: `validate-lead`
- Verify all template variables are defined in Novu

---

## Alternative: Bypass Email Verification (Development Only)

For **local testing only**, you can bypass email verification:

```typescript
// In lead-authenticator.service.ts, comment out email sending:

async triggerValidationMail(lead: Lead) {
  const token = this._generateTempToken(lead, [...permissions]);
  const randomKey = this.cryptoHelperService.generateRandomString(+process.env.LEAD_KEY_LENGTH!);
  await this.setToken(randomKey, new LeadToken({token}));
  await this.expireToken(randomKey, +process.env.VALIDATION_TOKEN_EXPIRY!);

  // BYPASS EMAIL SENDING IN DEV MODE
  if (process.env.NODE_ENV === 'development') {
    console.log('\n=== EMAIL BYPASS MODE ===');
    console.log(`Verification URL: http://localhost:27555/register/verify?token=${randomKey}`);
    console.log('=========================\n');
    return randomKey;
  }

  // Normal flow with Novu
  try {
    await this.notificationService.sendLeadValidationEmail(lead.email, {
      firstName: lead.firstName,
      companyName: lead.companyName,
      validationToken: randomKey,
    });
    this.logger.info(`Validation email sent to ${lead.email}`);
  } catch (error) {
    this.logger.error(`Failed to send validation email: ${error instanceof Error ? error.message : 'Unknown'}`);
  }

  return randomKey;
}
```

Then check console output for the verification URL and copy it manually.

---

## Next Steps After Email Verification Works

1. **Create additional Novu workflows:**
   - `welcome-tenant` - Welcome email after tenant provisioning
   - `invoice-reminder` - Billing reminders
   - `password-reset` - Password reset emails
   - `user-invitation` - Team member invitations

2. **Add "Resend Verification Email" button:**
   - Frontend: `/register` page
   - Backend: `POST /leads/{id}/resend-verification`

3. **Monitor email deliverability:**
   - Track bounce rate, open rate in Novu
   - Set up SPF/DKIM records for production domain
   - Use dedicated email service (SendGrid/AWS SES) in production

---

## Reference Files

| File | Purpose |
|------|---------|
| [lead-authenticator.service.ts:99](E:\Work\Ananta-Platform-Saas\arc-saas\services\tenant-management-service\src\services\lead-authenticator.service.ts:99) | Sends verification email |
| [notification.service.ts:133](E:\Work\Ananta-Platform-Saas\arc-saas\services\tenant-management-service\src\services\notifications\notification.service.ts:133) | Novu integration |
| [register/index.tsx:123](E:\Work\Ananta-Platform-Saas\arc-saas\apps\admin-app\src\pages\register\index.tsx:123) | "Check Your Email!" UI |
| [register/verify.tsx:40](E:\Work\Ananta-Platform-Saas\arc-saas\apps\admin-app\src\pages\register\verify.tsx:40) | Email verification page |
| [lead.controller.ts:128](E:\Work\Ananta-Platform-Saas\arc-saas\services\tenant-management-service\src\controllers\lead.controller.ts:128) | Verification endpoint |

---

**Last Updated:** December 14, 2024
